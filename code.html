
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Source Code &#8212; AMSIMP 1.0.0 documentation</title>
    <link rel="stylesheet" href="_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="References" href="refs.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="refs.html" title="References"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">AMSIMP 1.0.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Source Code</a></li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar">
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Contents</h2>
    <div class="sidebar-localtoc">
      <ul>
<li><a class="reference internal" href="#">Source Code</a><ul>
<li><a class="reference internal" href="#backend-class">Backend Class</a></li>
<li><a class="reference internal" href="#wind-class">Wind Class</a></li>
<li><a class="reference internal" href="#moist-class">Moist Class</a></li>
<li><a class="reference internal" href="#dynamics-class">Dynamics Class</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
</div>
  <h4>Previous topic</h4>
  <p class="topless"><a href="refs.html"
                        title="previous chapter">References</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/code.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="index.html">Docs</a></li>
              
              <li>Source Code</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="source-code">
<h1>Source Code<a class="headerlink" href="#source-code" title="Permalink to this headline">¶</a></h1>
<div class="section" id="backend-class">
<h2>Backend Class<a class="headerlink" href="#backend-class" title="Permalink to this headline">¶</a></h2>
<div class="highlight-cython notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>   1
   2
   3
   4
   5
   6
   7
   8
   9
  10
  11
  12
  13
  14
  15
  16
  17
  18
  19
  20
  21
  22
  23
  24
  25
  26
  27
  28
  29
  30
  31
  32
  33
  34
  35
  36
  37
  38
  39
  40
  41
  42
  43
  44
  45
  46
  47
  48
  49
  50
  51
  52
  53
  54
  55
  56
  57
  58
  59
  60
  61
  62
  63
  64
  65
  66
  67
  68
  69
  70
  71
  72
  73
  74
  75
  76
  77
  78
  79
  80
  81
  82
  83
  84
  85
  86
  87
  88
  89
  90
  91
  92
  93
  94
  95
  96
  97
  98
  99
 100
 101
 102
 103
 104
 105
 106
 107
 108
 109
 110
 111
 112
 113
 114
 115
 116
 117
 118
 119
 120
 121
 122
 123
 124
 125
 126
 127
 128
 129
 130
 131
 132
 133
 134
 135
 136
 137
 138
 139
 140
 141
 142
 143
 144
 145
 146
 147
 148
 149
 150
 151
 152
 153
 154
 155
 156
 157
 158
 159
 160
 161
 162
 163
 164
 165
 166
 167
 168
 169
 170
 171
 172
 173
 174
 175
 176
 177
 178
 179
 180
 181
 182
 183
 184
 185
 186
 187
 188
 189
 190
 191
 192
 193
 194
 195
 196
 197
 198
 199
 200
 201
 202
 203
 204
 205
 206
 207
 208
 209
 210
 211
 212
 213
 214
 215
 216
 217
 218
 219
 220
 221
 222
 223
 224
 225
 226
 227
 228
 229
 230
 231
 232
 233
 234
 235
 236
 237
 238
 239
 240
 241
 242
 243
 244
 245
 246
 247
 248
 249
 250
 251
 252
 253
 254
 255
 256
 257
 258
 259
 260
 261
 262
 263
 264
 265
 266
 267
 268
 269
 270
 271
 272
 273
 274
 275
 276
 277
 278
 279
 280
 281
 282
 283
 284
 285
 286
 287
 288
 289
 290
 291
 292
 293
 294
 295
 296
 297
 298
 299
 300
 301
 302
 303
 304
 305
 306
 307
 308
 309
 310
 311
 312
 313
 314
 315
 316
 317
 318
 319
 320
 321
 322
 323
 324
 325
 326
 327
 328
 329
 330
 331
 332
 333
 334
 335
 336
 337
 338
 339
 340
 341
 342
 343
 344
 345
 346
 347
 348
 349
 350
 351
 352
 353
 354
 355
 356
 357
 358
 359
 360
 361
 362
 363
 364
 365
 366
 367
 368
 369
 370
 371
 372
 373
 374
 375
 376
 377
 378
 379
 380
 381
 382
 383
 384
 385
 386
 387
 388
 389
 390
 391
 392
 393
 394
 395
 396
 397
 398
 399
 400
 401
 402
 403
 404
 405
 406
 407
 408
 409
 410
 411
 412
 413
 414
 415
 416
 417
 418
 419
 420
 421
 422
 423
 424
 425
 426
 427
 428
 429
 430
 431
 432
 433
 434
 435
 436
 437
 438
 439
 440
 441
 442
 443
 444
 445
 446
 447
 448
 449
 450
 451
 452
 453
 454
 455
 456
 457
 458
 459
 460
 461
 462
 463
 464
 465
 466
 467
 468
 469
 470
 471
 472
 473
 474
 475
 476
 477
 478
 479
 480
 481
 482
 483
 484
 485
 486
 487
 488
 489
 490
 491
 492
 493
 494
 495
 496
 497
 498
 499
 500
 501
 502
 503
 504
 505
 506
 507
 508
 509
 510
 511
 512
 513
 514
 515
 516
 517
 518
 519
 520
 521
 522
 523
 524
 525
 526
 527
 528
 529
 530
 531
 532
 533
 534
 535
 536
 537
 538
 539
 540
 541
 542
 543
 544
 545
 546
 547
 548
 549
 550
 551
 552
 553
 554
 555
 556
 557
 558
 559
 560
 561
 562
 563
 564
 565
 566
 567
 568
 569
 570
 571
 572
 573
 574
 575
 576
 577
 578
 579
 580
 581
 582
 583
 584
 585
 586
 587
 588
 589
 590
 591
 592
 593
 594
 595
 596
 597
 598
 599
 600
 601
 602
 603
 604
 605
 606
 607
 608
 609
 610
 611
 612
 613
 614
 615
 616
 617
 618
 619
 620
 621
 622
 623
 624
 625
 626
 627
 628
 629
 630
 631
 632
 633
 634
 635
 636
 637
 638
 639
 640
 641
 642
 643
 644
 645
 646
 647
 648
 649
 650
 651
 652
 653
 654
 655
 656
 657
 658
 659
 660
 661
 662
 663
 664
 665
 666
 667
 668
 669
 670
 671
 672
 673
 674
 675
 676
 677
 678
 679
 680
 681
 682
 683
 684
 685
 686
 687
 688
 689
 690
 691
 692
 693
 694
 695
 696
 697
 698
 699
 700
 701
 702
 703
 704
 705
 706
 707
 708
 709
 710
 711
 712
 713
 714
 715
 716
 717
 718
 719
 720
 721
 722
 723
 724
 725
 726
 727
 728
 729
 730
 731
 732
 733
 734
 735
 736
 737
 738
 739
 740
 741
 742
 743
 744
 745
 746
 747
 748
 749
 750
 751
 752
 753
 754
 755
 756
 757
 758
 759
 760
 761
 762
 763
 764
 765
 766
 767
 768
 769
 770
 771
 772
 773
 774
 775
 776
 777
 778
 779
 780
 781
 782
 783
 784
 785
 786
 787
 788
 789
 790
 791
 792
 793
 794
 795
 796
 797
 798
 799
 800
 801
 802
 803
 804
 805
 806
 807
 808
 809
 810
 811
 812
 813
 814
 815
 816
 817
 818
 819
 820
 821
 822
 823
 824
 825
 826
 827
 828
 829
 830
 831
 832
 833
 834
 835
 836
 837
 838
 839
 840
 841
 842
 843
 844
 845
 846
 847
 848
 849
 850
 851
 852
 853
 854
 855
 856
 857
 858
 859
 860
 861
 862
 863
 864
 865
 866
 867
 868
 869
 870
 871
 872
 873
 874
 875
 876
 877
 878
 879
 880
 881
 882
 883
 884
 885
 886
 887
 888
 889
 890
 891
 892
 893
 894
 895
 896
 897
 898
 899
 900
 901
 902
 903
 904
 905
 906
 907
 908
 909
 910
 911
 912
 913
 914
 915
 916
 917
 918
 919
 920
 921
 922
 923
 924
 925
 926
 927
 928
 929
 930
 931
 932
 933
 934
 935
 936
 937
 938
 939
 940
 941
 942
 943
 944
 945
 946
 947
 948
 949
 950
 951
 952
 953
 954
 955
 956
 957
 958
 959
 960
 961
 962
 963
 964
 965
 966
 967
 968
 969
 970
 971
 972
 973
 974
 975
 976
 977
 978
 979
 980
 981
 982
 983
 984
 985
 986
 987
 988
 989
 990
 991
 992
 993
 994
 995
 996
 997
 998
 999
1000
1001
1002
1003
1004
1005
1006
1007
1008
1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026
1027
1028
1029
1030
1031
1032
1033
1034
1035
1036
1037
1038
1039
1040
1041
1042
1043
1044
1045
1046
1047
1048
1049
1050
1051
1052
1053
1054
1055
1056
1057
1058
1059
1060
1061
1062
1063
1064
1065
1066
1067
1068
1069
1070
1071
1072
1073
1074
1075
1076
1077
1078
1079
1080
1081
1082
1083
1084
1085
1086
1087
1088
1089
1090
1091
1092
1093
1094
1095
1096
1097
1098
1099
1100
1101
1102
1103
1104
1105
1106
1107
1108
1109
1110
1111
1112
1113
1114
1115
1116
1117
1118
1119
1120
1121
1122
1123
1124
1125
1126
1127
1128
1129
1130
1131
1132
1133
1134
1135
1136
1137
1138
1139
1140
1141
1142
1143
1144
1145
1146
1147
1148
1149
1150
1151
1152
1153
1154
1155
1156
1157
1158
1159
1160
1161
1162
1163
1164
1165
1166
1167
1168
1169
1170
1171
1172
1173
1174
1175
1176
1177
1178
1179
1180
1181
1182
1183
1184
1185
1186
1187
1188
1189
1190
1191
1192
1193
1194
1195
1196
1197
1198
1199
1200
1201
1202
1203
1204
1205
1206
1207
1208
1209
1210
1211
1212
1213
1214
1215
1216
1217
1218
1219
1220
1221
1222
1223
1224
1225
1226
1227
1228
1229
1230
1231
1232
1233
1234
1235
1236
1237
1238
1239
1240
1241
1242
1243
1244
1245
1246
1247
1248
1249
1250
1251
1252
1253
1254
1255
1256
1257
1258
1259
1260
1261
1262
1263
1264
1265
1266
1267
1268
1269
1270
1271
1272
1273
1274
1275
1276
1277</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">#cython: linetrace=True</span>
<span class="c">#distutils: define_macros=CYTHON_TRACE_NOGIL=1</span>
<span class="c">#cython: language_level=3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">AMSIMP Backend Class. For information about this class is described below.</span>

<span class="sd">Copyright (C) 2020 AMSIMP</span>

<span class="sd">This program is free software: you can redistribute it and/or modify</span>
<span class="sd">it under the terms of the GNU General Public License as published by</span>
<span class="sd">the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">(at your option) any later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful,</span>
<span class="sd">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">GNU General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU General Public License</span>
<span class="sd">along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

<span class="c"># Importing Dependencies</span>
<span class="k">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="k">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="k">import</span> <span class="nn">socket</span>
<span class="k">from</span> <span class="nn">amsimp.download</span> <span class="k">cimport</span> <span class="n">Download</span>
<span class="k">from</span> <span class="nn">amsimp.download</span> <span class="k">import</span> <span class="n">Download</span>
<span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">constant</span>
<span class="k">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">units</span>
<span class="k">from</span> <span class="nn">astropy.units.quantity</span> <span class="k">import</span> <span class="n">Quantity</span>
<span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">from</span> <span class="nn">cpython</span> <span class="k">cimport</span> <span class="nb">bool</span>
<span class="k">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="k">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">ticker</span>
<span class="k">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="k">from</span> <span class="nn">cartopy.util</span> <span class="k">import</span> <span class="n">add_cyclic_point</span>
<span class="k">import</span> <span class="nn">iris</span>
<span class="k">from</span> <span class="nn">iris.coords</span> <span class="k">import</span> <span class="n">DimCoord</span>
<span class="k">from</span> <span class="nn">iris.cube</span> <span class="k">import</span> <span class="n">Cube</span>
<span class="k">from</span> <span class="nn">iris.coord_systems</span> <span class="k">import</span> <span class="n">GeogCS</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Backend</span><span class="p">(</span><span class="n">Download</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    AMSIMP Backend Class - This is the base class for AMSIMP, as such, all</span>
<span class="sd">    other classes within AMSIMP inherit this class, either directly or</span>
<span class="sd">    indirectly.</span>

<span class="sd">    For methods to be included in this class they must meet one of the following</span>
<span class="sd">    criteria:</span>
<span class="sd">    (1) they are considered essential components of the software.</span>
<span class="sd">    (2) the output of these methods are generated solely from the methods</span>
<span class="sd">    classified as (1).</span>
<span class="sd">    (3) these methods import data from the Global Data Assimilation System.</span>
<span class="sd">    This data is retrieved from the AMSIMP data repository, which is updated </span>
<span class="sd">    every hour.</span>
<span class="sd">    (4) they don&#39;t classify nicely into any other class.</span>
<span class="sd">    (5) they offer a visualisation of any of the methods found in this class.</span>
<span class="sd">    </span>
<span class="sd">    Below is a list of the methods included within this class, with a short</span>
<span class="sd">    description of their intended purpose and a bracketed number signifying</span>
<span class="sd">    which of the above criteria they meet. Please see the relevant class methods</span>
<span class="sd">    for more information. Please note that the unit information with AMSIMP</span>
<span class="sd">    is provided by the unit module within astropy.</span>

<span class="sd">    latitude_lines ~ generates a NumPy array of latitude lines (1). The unit</span>
<span class="sd">    of measurement is degrees.</span>
<span class="sd">    longitude_lines ~ generates a NumPy array of longitude lines (1). The unit</span>
<span class="sd">    of measurement is degrees.</span>
<span class="sd">    pressure_surfaces ~ generates a NumPy array of constant pressure</span>
<span class="sd">    surfaces (1). The unit of measurement is hectopascals. This is the</span>
<span class="sd">    isobaric coordinate system.</span>

<span class="sd">    coriolis_parameter ~ generates a NumPy arrray of the Coriolis parameter</span>
<span class="sd">    at various latitudes of the Earth&#39;s surface (2). The unit of measurement</span>
<span class="sd">    is radians per second.</span>

<span class="sd">    geopotential_height ~ outputs a NumPy array of geopotential height (3). The</span>
<span class="sd">    unit of measurement is metres.</span>
<span class="sd">    relative_humidity ~ outputs a NumPy array of relative humidity (3). The unit</span>
<span class="sd">    of measurement is percentage.</span>
<span class="sd">    temperature ~ outputs a NumPy array of temperature (3). The unit of</span>
<span class="sd">    measurement is Kelvin.</span>
<span class="sd">    remove_all_files ~ this method deletes any file created by the software,</span>
<span class="sd">    whilst downloading data from the AMSIMP Initial Atmospheric Conditions</span>
<span class="sd">    Data Repository (3). It does not, however, delete any forecast generated by,</span>
<span class="sd">    the, simulate, method. Please note that you may specifcy whether you would like</span>
<span class="sd">    to save such files throught the utilisation of the parameter, remove_files,</span>
<span class="sd">    when the class is initialised.</span>
<span class="sd">    </span>
<span class="sd">    pressure_thickness ~ outputs a NumPy array of atmospheric pressure</span>
<span class="sd">    thickness (4). The unit of measurement is metres.</span>
<span class="sd">    troposphere_boundaryline ~ generates a NumPy array of the</span>
<span class="sd">    troposphere - stratosphere boundary line (4). The unit of measurement is</span>
<span class="sd">    metres.</span>
<span class="sd">    </span>
<span class="sd">    longitude_contourf ~ generates a contour plot for a desired atmospheric</span>
<span class="sd">    process, with the axes being latitude, and longitude (5).</span>
<span class="sd">    altitude_contourf ~ generates a contour plot for a desired atmospheric</span>
<span class="sd">    process, with the axes being latitude, and altitude (5).</span>
<span class="sd">    thickness_contourf ~ generates a contour plot for pressure thickness,</span>
<span class="sd">    with the axes being latitude and longitude. This plot is then layed</span>
<span class="sd">    on top of a EckertIII global projection (5).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Define units of measurement for AMSIMP.</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">units</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="nb">int</span> <span class="n">delta_latitude</span><span class="o">=</span><span class="mf">5</span><span class="p">,</span>
            <span class="nb">int</span> <span class="n">delta_longitude</span><span class="o">=</span><span class="mf">5</span><span class="p">,</span>
            <span class="n">forecast_length</span><span class="o">=</span><span class="mf">72</span><span class="p">,</span> 
            <span class="n">delta_t</span><span class="o">=</span><span class="mf">2</span><span class="p">,</span> 
            <span class="nb">bool</span> <span class="n">ai</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
            <span class="n">data_size</span><span class="o">=</span><span class="mf">150</span><span class="p">,</span> 
            <span class="n">epochs</span><span class="o">=</span><span class="mf">200</span><span class="p">,</span> 
            <span class="n">input_date</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
            <span class="nb">bool</span> <span class="n">input_data</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">psurfaces</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">lat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">lon</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
            <span class="n">temp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
            <span class="n">rh</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
            <span class="n">u</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
            <span class="n">v</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="nb">dict</span> <span class="n">constants</span><span class="o">=</span><span class="p">{</span>
                <span class="s">&quot;sidereal_day&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">23</span> <span class="o">+</span> <span class="p">(</span><span class="mf">56</span> <span class="o">/</span> <span class="mf">60</span><span class="p">))</span> <span class="o">*</span> <span class="mf">3600</span><span class="p">,</span>
                <span class="s">&quot;angular_rotation_rate&quot;</span><span class="p">:</span> <span class="p">((</span><span class="mf">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mf">23</span> <span class="o">+</span> <span class="p">(</span><span class="mf">56</span> <span class="o">/</span> <span class="mf">60</span><span class="p">))</span> <span class="o">*</span> <span class="mf">3600</span><span class="p">)),</span>
                <span class="s">&quot;planet_radius&quot;</span><span class="p">:</span> <span class="n">constant</span><span class="o">.</span><span class="n">R_earth</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s">&quot;planet_mass&quot;</span><span class="p">:</span> <span class="n">constant</span><span class="o">.</span><span class="n">M_earth</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s">&quot;specific_heat_capacity_psurface&quot;</span><span class="p">:</span> <span class="mf">718</span><span class="p">,</span>
                <span class="s">&quot;gravitational_acceleration&quot;</span><span class="p">:</span> <span class="mf">9.80665</span><span class="p">,</span>
                <span class="s">&quot;planet&quot;</span><span class="p">:</span> <span class="s">&quot;Earth&quot;</span>
            <span class="p">}</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The parameters, delta_latitude and delta_longitude, defines the</span>
<span class="sd">        horizontal resolution between grid points within the software. The</span>
<span class="sd">        parameter values must be between 1 and 10 degrees if you are utilising</span>
<span class="sd">        the default initial conditions included within the software. Defaults</span>
<span class="sd">        to a value of 5 degrees.</span>

<span class="sd">        The parameter, input_date, allows the end-user to specify the initial</span>
<span class="sd">        date at which the forecast is generated from. Please note that</span>
<span class="sd">        currently you cannot specify dates before Janurary 2020. Please also</span>
<span class="sd">        note that the latest data available to the software is typically</span>
<span class="sd">        from three days ago. This is due to the rate at which the NOAA</span>
<span class="sd">        updates the data on the Global Data Assimilation System website. This</span>
<span class="sd">        feature is intended for situations where the default initial conditions</span>
<span class="sd">        included within the software are being used.</span>

<span class="sd">        The parameter, input_data, is a boolean value, and when set to True,</span>
<span class="sd">        it will allow the end-user to provide their own initial conditions</span>
<span class="sd">        to the software. Please note that this feature has not been fully</span>
<span class="sd">        tested as of this moment, and such is experimental for the time</span>
<span class="sd">        being.</span>

<span class="sd">        The parameter, ai, is a boolean value, and when set to True, a </span>
<span class="sd">        recurrent neural network will be trained on the amount of days </span>
<span class="sd">        specified by the parameter, data_size. A prediction by the</span>
<span class="sd">        recurrent neural network will be generated, and will be </span>
<span class="sd">        combined with a traditional physical model of the atmosphere.</span>
<span class="sd">        It can also be used independently. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Make the aforementioned variables available else where in the class.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_latitude</span> <span class="o">=</span> <span class="n">delta_latitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_longitude</span> <span class="o">=</span> <span class="n">delta_longitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_date</span> <span class="o">=</span> <span class="n">input_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="n">input_data</span>

        <span class="c"># The date at which the initial conditions was gathered (i.e. how</span>
        <span class="c"># recent the data is).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_date</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data_date_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
                <span class="s">&quot;https://github.com/amsimp/initial-conditions/raw/master/date.npy&quot;</span><span class="p">,</span> 
                <span class="n">bar</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">data_date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_date_file</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">data_date_file</span><span class="p">)</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">data_date</span><span class="p">[</span><span class="mf">2</span><span class="p">]),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">data_date</span><span class="p">[</span><span class="mf">1</span><span class="p">]),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">data_date</span><span class="p">[</span><span class="mf">0</span><span class="p">]),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">data_date</span><span class="p">[</span><span class="mf">3</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">date</span>
        <span class="k">else</span><span class="p">:</span>        
            <span class="c"># Ensure input_date is of the type &quot;datetime.datetime&quot;.</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_date</span><span class="p">)</span> <span class="o">!=</span> <span class="n">datetime</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;input_date must of the type &#39;datetime.datetime&#39;. The value of input_date was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">input_date</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_date</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">date</span>

        <span class="c"># Ensure input_data is a boolean value.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&quot;input_data must be a boolean value. The value of input_data was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c"># Function to ensure that the input data is 3 dimensional.</span>
        <span class="k">def</span> <span class="nf">dimension</span><span class="p">(</span><span class="n">input_variable</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">input_variable</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;All input data variables (height, rh, temp, u, v) must be a 3 dimensional.&quot;</span>
                <span class="p">)</span>

        <span class="c"># Function to check if a function is a NumPy array, or a list.</span>
        <span class="k">def</span> <span class="nf">type_check</span><span class="p">(</span><span class="n">input_variable</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">input_variable</span><span class="p">)</span> <span class="o">==</span> <span class="n">Quantity</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">input_variable</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">input_variable</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;All input data variables must be either NumPy arrays, or lists.&quot;</span>
                <span class="p">)</span>
        
        <span class="c"># Function to check if grid input variables are 1 dimensional.</span>
        <span class="k">def</span> <span class="nf">dimension_grid</span><span class="p">(</span><span class="n">input_variable</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">input_variable</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;All grid input variables (psurfaces, lat, lon) must be a 1 dimensional.&quot;</span>
                <span class="p">)</span>

        <span class="c"># Function to convert input lists into NumPy arrays.</span>
        <span class="k">def</span> <span class="nf">list_to_numpy</span><span class="p">(</span><span class="n">input_variable</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">input_variable</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">input_variable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">input_variable</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">input_variable</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
            <span class="c"># Ensure input data variables are either NumPy arrays, or lists.</span>
            <span class="n">type_check</span><span class="p">(</span><span class="n">psurfaces</span><span class="p">)</span>
            <span class="n">type_check</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
            <span class="n">type_check</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
            <span class="n">type_check</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
            <span class="n">type_check</span><span class="p">(</span><span class="n">rh</span><span class="p">)</span>
            <span class="n">type_check</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="n">type_check</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="n">type_check</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="c"># Check if grid input variables are 1 dimensional.</span>
            <span class="n">dimension_grid</span><span class="p">(</span><span class="n">psurfaces</span><span class="p">)</span>
            <span class="n">dimension_grid</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
            <span class="n">dimension_grid</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>

            <span class="c"># Check if input data is 3 dimensional.</span>
            <span class="n">dimension</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
            <span class="n">dimension</span><span class="p">(</span><span class="n">rh</span><span class="p">)</span>
            <span class="n">dimension</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="n">dimension</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="n">dimension</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="c"># Convert input data lists to NumPy arrays.</span>
            <span class="n">list_to_numpy</span><span class="p">(</span><span class="n">psurfaces</span><span class="p">)</span>
            <span class="n">list_to_numpy</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
            <span class="n">list_to_numpy</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
            <span class="n">list_to_numpy</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
            <span class="n">list_to_numpy</span><span class="p">(</span><span class="n">rh</span><span class="p">)</span>
            <span class="n">list_to_numpy</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="n">list_to_numpy</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="n">list_to_numpy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="c"># Add units to input variables.</span>
            <span class="c"># psurfaces variable.</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">psurfaces</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
                <span class="n">psurfaces</span> <span class="o">=</span> <span class="n">psurfaces</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">hPa</span>
            <span class="c"># lat variable.</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">deg</span>
            <span class="c"># lon variable.</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">height</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">deg</span>
            <span class="c"># height variable.</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">height</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">m</span>
            <span class="c"># rh variable.</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rh</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
                <span class="n">rh</span> <span class="o">=</span> <span class="n">rh</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">percent</span>
            <span class="c"># temp variable.</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
               <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">K</span>
            <span class="c"># u variable.</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
               <span class="n">u</span> <span class="o">=</span> <span class="n">u</span> <span class="o">*</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
            <span class="c"># v variable.</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
               <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>

        <span class="c"># Ensure self.delta_latitude is between 1 and 10 degrees.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_latitude</span> <span class="o">&gt;</span> <span class="mf">10</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_latitude</span> <span class="o">&lt;</span> <span class="mf">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;delta_latitude must be a positive integer between 1 and 10. The value of delta_latitude was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">delta_latitude</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c"># Ensure self.delta_longitude is between 1 and 10 degrees.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_longitude</span> <span class="o">&gt;</span> <span class="mf">10</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_longitude</span> <span class="o">&lt;</span> <span class="mf">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;delta_longitude must be a positive integer between 1 and 10. The value of delta_longitude was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">delta_longitude</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">folder</span> <span class="o">=</span> <span class="s">&quot;https://github.com/amsimp/initial-conditions/raw/master/initial_conditions/&quot;</span>

            <span class="c"># Define date.</span>
            <span class="n">year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span>
            <span class="n">month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">month</span>
            <span class="n">day</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">day</span>
            <span class="n">hour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">hour</span>

            <span class="c"># Adds zero before single digit numbers.</span>
            <span class="k">if</span> <span class="n">day</span> <span class="o">&lt;</span> <span class="mf">10</span><span class="p">:</span>
                <span class="n">day</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">month</span> <span class="o">&lt;</span> <span class="mf">10</span><span class="p">:</span>
                <span class="n">month</span> <span class="o">=</span>  <span class="s">&quot;0&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">hour</span> <span class="o">&lt;</span> <span class="mf">10</span><span class="p">:</span>
                <span class="n">hour</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span>

            <span class="c"># Converts integers to strings.</span>
            <span class="n">day</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>
            <span class="n">month</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>
            <span class="n">year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="n">hour</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span>

            <span class="n">folder</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">year</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">month</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">day</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">hour</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>
            <span class="p">)</span>
            <span class="c"># The url to the NumPy pressure surfaces file stored on the AMSIMP</span>
            <span class="c"># Initial Conditions Data repository.</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="s">&quot;initial_conditions.nc&quot;</span>

            <span class="c"># Download the NumPy file and store the NumPy array into a variable.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cube</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&quot;initial_conditions.nc&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>  
                <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="n">cube</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            
            <span class="n">height</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s">&quot;geopotential_height&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s">&quot;air_temperature&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span>
            <span class="n">rh</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s">&quot;relative_humidity&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s">&quot;x_wind&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s">&quot;y_wind&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span>

        <span class="c"># Constants dictionary.</span>
        <span class="c"># Sidereal day.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;sidereal_day&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
            <span class="n">constants</span><span class="p">[</span><span class="s">&quot;sidereal_day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s">&quot;sidereal_day&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span>
        <span class="c"># Angular rotation rate.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;angular_rotation_rate&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
            <span class="n">constants</span><span class="p">[</span><span class="s">&quot;angular_rotation_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s">&quot;angular_rotation_rate&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">units</span><span class="o">.</span><span class="n">rad</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span>
            <span class="p">)</span>
        <span class="c"># Planet radius.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;planet_radius&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
            <span class="n">constants</span><span class="p">[</span><span class="s">&quot;planet_radius&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s">&quot;planet_radius&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">m</span>
        <span class="c"># Planet mass.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;planet_mass&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
            <span class="n">constants</span><span class="p">[</span><span class="s">&quot;planet_mass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s">&quot;planet_mass&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">kg</span>
        <span class="c"># Specific heat capacity on a constant pressure surface.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;specific_heat_capacity_psurface&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
            <span class="n">constants</span><span class="p">[</span><span class="s">&quot;specific_heat_capacity_psurface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span>
                <span class="s">&quot;specific_heat_capacity_psurface&quot;</span>
            <span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">J</span> <span class="o">/</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">kg</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">K</span><span class="p">))</span>
        <span class="c"># Gravitational acceleration.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;gravitational_acceleration&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span> 
            <span class="n">constants</span><span class="p">[</span><span class="s">&quot;gravitational_acceleration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s">&quot;gravitational_acceleration&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">units</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">s</span> <span class="o">**</span> <span class="mf">2</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c"># Planet</span>
        <span class="n">planet</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s">&quot;planet&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">planet</span> <span class="o">=</span> <span class="n">planet</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">planet</span> <span class="o">=</span> <span class="n">planet</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="c"># Gas constant</span>
        <span class="n">R</span> <span class="o">=</span> <span class="mf">287.05799596</span> <span class="o">*</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">J</span> <span class="o">/</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">kg</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">K</span><span class="p">))</span>
        <span class="n">constants</span><span class="p">[</span><span class="s">&quot;gas_constant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>
        <span class="c"># Universal gravitational constant.</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">constant</span><span class="o">.</span><span class="n">G</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">G</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">constants</span><span class="p">[</span><span class="s">&quot;universal_gravitational_constant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">G</span>

        <span class="c"># Make the input data variables available else where in the class.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psurfaces</span> <span class="o">=</span> <span class="n">psurfaces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_height</span> <span class="o">=</span> <span class="n">height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_rh</span> <span class="o">=</span> <span class="n">rh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_temp</span> <span class="o">=</span> <span class="n">temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_u</span> <span class="o">=</span> <span class="n">u</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_v</span> <span class="o">=</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constants</span> <span class="o">=</span> <span class="n">constants</span>

        <span class="c"># Predefined Constants.</span>
        <span class="c"># Angular rotation rate of the planet.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sidereal_day</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s">&quot;sidereal_day&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Upomega</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s">&quot;angular_rotation_rate&quot;</span><span class="p">]</span>
        <span class="c"># Mean radius of the planet.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;planet_radius&quot;</span><span class="p">]</span>
        <span class="c"># Mass of the planet.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;planet_mass&quot;</span><span class="p">]</span>
        <span class="c"># The specific heat capacity on a constant pressure surface.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;specific_heat_capacity_psurface&quot;</span><span class="p">]</span>
        <span class="c"># Gravitational acceleration.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;gravitational_acceleration&quot;</span><span class="p">]</span>
        <span class="c"># Planet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constants</span><span class="p">[</span><span class="s">&quot;planet&quot;</span><span class="p">]</span>
        <span class="c"># Gas Constant.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s">&quot;gas_constant&quot;</span><span class="p">]</span>
        <span class="c"># Universal gravitational constant.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s">&quot;universal_gravitational_constant&quot;</span><span class="p">]</span>

        <span class="c"># Function to check for an internet connection.</span>
        <span class="k">def</span> <span class="nf">is_connected</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s">&quot;www.github.com&quot;</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="mf">80</span><span class="p">),</span> <span class="mf">2</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Check for an internet connection.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_connected</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;You must connect to the internet in order to utilise AMSIMP.&quot;</span>
                    <span class="o">+</span> <span class="s">&quot; Apologies for any inconvenience caused.&quot;</span>
                <span class="p">)</span>

        <span class="c"># RNN.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">data_size</span>

        <span class="c"># Ensure epochs is an integer value.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&quot;epochs must be a integer value. The value of epochs was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ai</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c"># Ensure epochs is a natural number.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">&gt;</span> <span class="mf">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&quot;epochs must be a integer value. The value of epochs was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ai</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c"># Ensure data_size is an integer value.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&quot;data_size must be a integer value. The value of data_size was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ai</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c"># Ensure data_size is a natural number and is greater than 14.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_size</span> <span class="o">&gt;</span> <span class="mf">14</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&quot;data_size must be a integer value. The value of data_size was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ai</span>
                <span class="p">)</span>
            <span class="p">)</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">latitude_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of latitude lines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">cdef</span> <span class="kt">float</span> <span class="nf">i</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
            <span class="n">latitude_lines</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">i</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                    <span class="o">-</span><span class="mf">89</span><span class="p">,</span> <span class="mf">90</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_latitude</span>
                <span class="p">)</span>
            <span class="p">]</span>

            <span class="c"># Convert list to NumPy array and add the unit of measurement.</span>
            <span class="n">latitude_lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">latitude_lines</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">deg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">latitude_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span>

        <span class="k">return</span> <span class="n">latitude_lines</span>
    
    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">longitude_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of longitude lines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">cdef</span> <span class="kt">float</span> <span class="nf">i</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
            <span class="n">longitude_lines</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">i</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                    <span class="mf">0</span><span class="p">,</span> <span class="mf">360</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_longitude</span>
                <span class="p">)</span>
            <span class="p">]</span>

            <span class="c"># Convert list to NumPy array and add the unit of measurement.</span>
            <span class="n">longitude_lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">longitude_lines</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">deg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">longitude_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span>

        <span class="k">return</span> <span class="n">longitude_lines</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">pressure_surfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim_3d</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of the constant pressure surfaces. This</span>
<span class="sd">        is the isobaric coordinate system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
            <span class="n">pressure_surfaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_rh</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="s">&#39;pressure&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">points</span>
            <span class="n">pressure_surfaces</span> <span class="o">=</span> <span class="n">pressure_surfaces</span><span class="p">[::</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Pa</span>
            <span class="n">pressure_surfaces</span> <span class="o">=</span> <span class="n">pressure_surfaces</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">hPa</span><span class="p">)</span>
            <span class="n">pressure_surfaces</span> <span class="o">=</span> <span class="n">pressure_surfaces</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pressure_surfaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psurfaces</span><span class="o">.</span><span class="n">value</span>

        <span class="c"># Convert Pressure Array into 3D Array.</span>
        <span class="k">if</span> <span class="n">dim_3d</span><span class="p">:</span>
            <span class="n">list_pressure</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pressure_surfaces</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">())</span>
                <span class="p">))</span> <span class="o">+</span> <span class="n">p</span>
                
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">list_pressure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">pressure_surfaces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">list_pressure</span><span class="p">)</span>

        <span class="n">pressure_surfaces</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">hPa</span>
        <span class="k">return</span> <span class="n">pressure_surfaces</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">gradient_longitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Explain here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Determine gradient with respect to longitude.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">longitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c"># Define variable types.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">parameter_central</span><span class="p">,</span> <span class="nf">parameter_boundaries</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">parameter_lgmt</span><span class="p">,</span> <span class="nf">parameter_rgmt</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">lon_lgmt</span><span class="p">,</span> <span class="nf">lon_rgmt</span><span class="p">,</span> <span class="nf">lon_boundaries</span>

        <span class="c"># Compute gradient.</span>
        <span class="c"># Central points.</span>
        <span class="n">parameter_central</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span>
            <span class="n">parameter</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mf">2</span>
        <span class="p">)</span>

        <span class="c"># Boundaries.</span>
        <span class="c"># Define atmospheric parameter boundaries.</span>
        <span class="n">parameter_lgmt</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mf">3</span><span class="p">:]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">parameter_rgmt</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mf">3</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="c"># Define longitude boundaries.</span>
        <span class="n">lon_lgmt</span> <span class="o">=</span> <span class="n">longitude</span><span class="p">[</span><span class="o">-</span><span class="mf">3</span><span class="p">:]</span>
        <span class="n">lon_rgmt</span> <span class="o">=</span> <span class="n">longitude</span><span class="p">[:</span><span class="mf">3</span><span class="p">]</span>
        <span class="c"># Concatenate atmospheric parameter boundaries.</span>
        <span class="n">parameter_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">parameter_lgmt</span><span class="p">,</span> <span class="n">parameter_rgmt</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mf">2</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">parameter</span><span class="o">.</span><span class="n">unit</span>
        <span class="c"># Concatenate longitude boundaries.</span>
        <span class="n">lon_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">lon_lgmt</span><span class="p">,</span> <span class="n">lon_rgmt</span><span class="p">))</span>
        <span class="c"># Compute gradient at boundaries.</span>
        <span class="n">parameter_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span>
            <span class="n">parameter_boundaries</span><span class="p">,</span> <span class="n">lon_boundaries</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mf">2</span>
        <span class="p">)</span>
        <span class="c"># Redefine parameter as computed gradient.</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="n">parameter_central</span>
        <span class="n">parameter</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_boundaries</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mf">2</span><span class="p">]</span>
        <span class="n">parameter</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_boundaries</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mf">3</span><span class="p">]</span>

        <span class="c"># Make 1d latitude array into a 3d latitude array.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">latitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">())</span>
        <span class="n">latitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_3dimensional_array</span><span class="p">(</span>
            <span class="n">parameter</span><span class="o">=</span><span class="n">latitude</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mf">1</span>
        <span class="p">)</span>

        <span class="c"># Handle longitudinal variation with respect to latitude.</span>
        <span class="n">gradient_longitude</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mf">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">latitude</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span> <span class="o">*</span> <span class="n">parameter</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">gradient_longitude</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">gradient_latitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Explain here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Define variable.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">latitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c"># Determine gradient with respect to latitude.</span>
        <span class="n">gradient_latitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span>
            <span class="n">parameter</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mf">1</span>
        <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">parameter</span><span class="o">.</span><span class="n">unit</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gradient_latitude</span>
    
    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">gradient_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Explain here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Define variable.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span>

         <span class="c"># Determine gradient with respect to pressure.</span>
        <span class="n">gradient_pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span>
            <span class="n">parameter</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mf">0</span>
        <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">parameter</span><span class="o">.</span><span class="n">unit</span> <span class="o">/</span> <span class="n">pressure</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gradient_pressure</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">make_3dimensional_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mf">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Explain here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mf">1</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mf">2</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>

        <span class="n">list_parameter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameter</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">unit</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">list_parameter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">list_parameter</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit</span>

        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mf">1</span><span class="p">:</span>
            <span class="n">parameter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mf">2</span><span class="p">:</span>
            <span class="n">parameter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">0</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">parameter</span>

    <span class="k">cpdef</span> <span class="kt">dict</span> <span class="nf">retrieve_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Explain here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">constants</span>

<span class="c"># -----------------------------------------------------------------------------------------</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">coriolis_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy arrray of the Coriolis parameter at various latitudes</span>
<span class="sd">        of the Earth&#39;s surface.</span>
<span class="sd">        </span>
<span class="sd">        The Coriolis parameter is defined as two times the angular rotation of</span>
<span class="sd">        the Earth by the sin of the latitude you are interested in.</span>

<span class="sd">        Equation:</span>
<span class="sd">            f_0 = 2 \* Upomega * sin(\phi)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coriolis_parameter</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Upomega</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()))</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">coriolis_parameter</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">geopotential_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method imports geopotential height data from a NetCDF file, which is</span>
<span class="sd">        located in the AMSIMP Initial Conditions Data Repository on GitHub.</span>
<span class="sd">        The data stored within this repo is updated every six hours by amsimp-bot.</span>
<span class="sd">        Following which, it outputs a NumPy array in the shape of</span>
<span class="sd">        (len(pressure_surfaces), len(latitude_lines), len(longitude_lines)).</span>

<span class="sd">        Geopotential Height is the height above sea level of a pressure level.</span>
<span class="sd">        For example, if a station reports that the 500 hPa height at its</span>
<span class="sd">        location is 5600 m, it means that the level of the atmosphere over</span>
<span class="sd">        that station at which the atmospheric pressure is 500 hPa is 5600</span>
<span class="sd">        meters above sea level.</span>

<span class="sd">        I strongly recommend storing the output into a variable in order to</span>
<span class="sd">        prevent the need to repeatly self.download the file. For more information,</span>
<span class="sd">        visit https://github.com/amsimp/initial-conditions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
            <span class="c"># Input data.</span>
            <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_height</span>

            <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Pa</span><span class="p">)</span>
            <span class="c"># Grid.</span>
            <span class="n">grid_points</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s">&#39;pressure&#39;</span><span class="p">,</span>  <span class="n">pressure</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;latitude&#39;</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;longitude&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>                
            <span class="p">]</span>

            <span class="c"># Interpolation</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                <span class="n">grid_points</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="c"># Get data.</span>
            <span class="n">geopotential_height</span> <span class="o">=</span> <span class="n">height</span><span class="o">.</span><span class="n">data</span>
            <span class="n">geopotential_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">geopotential_height</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

            <span class="n">geopotential_height</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">geopotential_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_height</span>
        
        <span class="k">return</span> <span class="n">geopotential_height</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">relative_humidity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method imports relative humidity data from a NetCDF file, which is</span>
<span class="sd">        located in the AMSIMP Initial Conditions Data Repository on GitHub.</span>
<span class="sd">        The data stored within this repo is updated every six hours by amsimp-bot.</span>
<span class="sd">        Following which, it outputs a NumPy array in the shape of</span>
<span class="sd">        (len(pressure_surfaces), len(latitude_lines), len(longitude_lines)).</span>
<span class="sd">        </span>
<span class="sd">        Relative Humidity is the amount of water vapour present in air expressed</span>
<span class="sd">        as a percentage of the amount needed for saturation at the same temperature.</span>

<span class="sd">        I strongly recommend storing the output into a variable in order to</span>
<span class="sd">        prevent the need to repeatly self.download the file. For more information,</span>
<span class="sd">        visit https://github.com/amsimp/initial-conditions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
            <span class="c"># Input data.</span>
            <span class="n">rh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_rh</span>

            <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Pa</span><span class="p">)</span>
            <span class="c"># Grid.</span>
            <span class="n">grid_points</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s">&#39;pressure&#39;</span><span class="p">,</span>  <span class="n">pressure</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;latitude&#39;</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;longitude&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>                
            <span class="p">]</span>

            <span class="c"># Interpolation</span>
            <span class="n">rh</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                <span class="n">grid_points</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="c"># Get data.</span>
            <span class="n">relative_humidity</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">data</span>
            <span class="n">relative_humidity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">relative_humidity</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

            <span class="n">relative_humidity</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">percent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">relative_humidity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_rh</span>
        
        <span class="k">return</span> <span class="n">relative_humidity</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method imports temperature data from a NetCDF file, which is</span>
<span class="sd">        located in the AMSIMP Initial Conditions Data Repository on GitHub.</span>
<span class="sd">        The data stored within this repo is updated every six hours by amsimp-bot.</span>
<span class="sd">        Following which, it outputs a NumPy array in the shape of</span>
<span class="sd">        (len(pressure_surfaces), len(latitude_lines), len(longitude_lines)).</span>

<span class="sd">        Temperature is defined as the mean kinetic energy density of molecular</span>
<span class="sd">        motion.</span>

<span class="sd">        I strongly recommend storing the output into a variable in order to</span>
<span class="sd">        prevent the need to repeatly self.download the file. For more information,</span>
<span class="sd">        visit https://github.com/amsimp/initial-conditions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
            <span class="c"># Input data.</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_temp</span>

            <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Pa</span><span class="p">)</span>
            <span class="c"># Grid.</span>
            <span class="n">grid_points</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s">&#39;pressure&#39;</span><span class="p">,</span>  <span class="n">pressure</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;latitude&#39;</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;longitude&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>                
            <span class="p">]</span>

            <span class="c"># Interpolation</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                <span class="n">grid_points</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="c"># Get data.</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">data</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">temperature</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

            <span class="n">temperature</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">K</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_temp</span>
        
        <span class="k">return</span> <span class="n">temperature</span>

    <span class="k">cpdef</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method deletes any file created by the software,</span>
<span class="sd">        whilst downloading data from the AMSIMP Initial Atmospheric</span>
<span class="sd">        Conditions Data Repository. It does not, however, delete any</span>
<span class="sd">        forecast generated and saved by the simualte method.</span>

<span class="sd">        This command will also cause the Python interpreter to close</span>
<span class="sd">        and exit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Initial atmospheric conditions file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;initial_conditions.nc&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="c"># Close Python.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">pressure_thickness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="o">=</span><span class="mf">1000</span><span class="p">,</span> <span class="n">p2</span><span class="o">=</span><span class="mf">500</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of pressure thickness between two defined</span>
<span class="sd">        constant pressure surfaces.</span>

<span class="sd">        Pressure thickness is defined as the distance between two</span>
<span class="sd">        pressure surfaces. Pressure thickness is determined through the</span>
<span class="sd">        hypsometric equation.</span>

<span class="sd">        Equation:</span>
<span class="sd">            h = z_2 - z_1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Ensure p1 is greater than p2.</span>
        <span class="k">if</span> <span class="n">p1</span> <span class="o">&lt;</span> <span class="n">p2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Please note that p1 must be greater than p2.&quot;</span><span class="p">)</span>

        <span class="c"># Find the nearest constant pressure surface to p1 and p2 in pressure.</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">indx_p1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">p1</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">indx_p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">p2</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="n">pressure_thickness</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geopotential_height</span><span class="p">()[</span><span class="n">indx_p2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">geopotential_height</span><span class="p">()[</span><span class="n">indx_p1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">pressure_thickness</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">troposphere_boundaryline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of the troposphere - stratosphere</span>
<span class="sd">        boundary line in the shape (len(longitude_lines), len(latitude_lines).</span>
<span class="sd">        This is calculated by looking at the vertical temperature profile in</span>
<span class="sd">        the method, amsimp.Backend.temperature().</span>

<span class="sd">        Explain here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
        <span class="n">grad_temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">gradient_temperature</span> <span class="o">=</span> <span class="n">grad_temperature</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="n">gradient_temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">gradient_temperature</span><span class="p">,</span> <span class="p">(</span><span class="mf">2</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="mf">0</span><span class="p">))</span>

        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">psurface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>

        <span class="k">cdef</span> <span class="kt">list</span> <span class="nf">trop_strat_line</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">cdef</span> <span class="kt">list</span> <span class="nf">lat_trop_strat_line</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">temp</span><span class="p">,</span> <span class="nf">t</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">n</span>
        <span class="k">cdef</span> <span class="kt">float</span> <span class="nf">t_n</span><span class="p">,</span> <span class="nf">p</span>
        <span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="n">gradient_temperature</span><span class="p">:</span>
            <span class="n">lat_trop_strat_line</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mf">0</span>
                <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">t_n</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0</span><span class="p">:</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">psurface</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">400</span><span class="p">:</span>
                            <span class="n">lat_trop_strat_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mf">1</span>
            <span class="n">trop_strat_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lat_trop_strat_line</span><span class="p">)</span>

        <span class="n">troposphere_boundaryline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">trop_strat_line</span><span class="p">)</span>
        <span class="n">troposphere_boundaryline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">troposphere_boundaryline</span><span class="p">,</span> <span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="mf">0</span><span class="p">))</span> 
        <span class="n">troposphere_boundaryline</span> <span class="o">*=</span> <span class="n">units</span><span class="o">.</span><span class="n">hPa</span>
        <span class="k">return</span> <span class="n">troposphere_boundaryline</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

    <span class="k">def</span> <span class="nf">longitude_contourf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s">&quot;air_temperature&quot;</span><span class="p">,</span> <span class="n">psurface</span><span class="o">=</span><span class="mf">1000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots a desired atmospheric process on a contour plot, with the axes</span>
<span class="sd">        being latitude and longitude. This plot is then layed on top of a</span>
<span class="sd">        EckertIII global projection. </span>
<span class="sd">        </span>
<span class="sd">        For the raw data, please see the other methods found in this class.</span>

<span class="sd">        If you would like a particular atmospheric process to</span>
<span class="sd">        be added to this method, either create an issue on</span>
<span class="sd">        GitHub or send an email to support@amsimp.com.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planet</span> <span class="o">==</span> <span class="s">&quot;Earth&quot;</span><span class="p">:</span>        
            <span class="c"># Ensure, which, is a string.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;which must be a string of the name of the atmospheric parameter of interest.&quot;</span>
                <span class="p">)</span>

            <span class="c"># Index of the nearest pressure surface in amsimp.Backend.pressure_surfaces()</span>
            <span class="n">indx_psurface</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">psurface</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            
            <span class="c"># Defines the axes, and the data.</span>
            <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;temperature&quot;</span> <span class="ow">or</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;air_temperature&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">()[</span><span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Air Temperature&quot;</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (K)&quot;</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;geopotential_height&quot;</span> <span class="ow">or</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;height&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geopotential_height</span><span class="p">()[</span><span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Geopotential Height&quot;</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (m)&quot;</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;density&quot;</span> <span class="ow">or</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;atmospheric_density&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">()[</span><span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Atmospheric Density&quot;</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; ($</span><span class="se">\\</span><span class="s">frac{kg}{m^3}$)&quot;</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;humidity&quot;</span> <span class="ow">or</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;relative_humidity&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_humidity</span><span class="p">()[</span><span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Relative Humidity&quot;</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (%)&quot;</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;virtual_temperature&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtual_temperature</span><span class="p">()[</span><span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Virtual Temperature&quot;</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (K)&quot;</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;vapor_pressure&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vapor_pressure</span><span class="p">()[</span><span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Vapor Pressure&quot;</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (hPa)&quot;</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;potential_temperature&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_temperature</span><span class="p">()[</span><span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Potential Temperature&quot;</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (K)&quot;</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;precipitable_water&quot;</span> <span class="ow">or</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;precipitable_water_vapor&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precipitable_water</span><span class="p">()</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Precipitable Water Vapor&quot;</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (mm)&quot;</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;zonal_wind&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind</span><span class="p">()[</span><span class="mf">0</span><span class="p">][</span><span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Zonal Wind&quot;</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; ($</span><span class="se">\\</span><span class="s">frac{m}{s}$)&quot;</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;meridional_wind&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind</span><span class="p">()[</span><span class="mf">1</span><span class="p">][</span><span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Meridional Wind&quot;</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; ($</span><span class="se">\\</span><span class="s">frac{m}{s}$)&quot;</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;wind&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind</span><span class="p">()</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">**</span><span class="mf">2</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">**</span><span class="mf">2</span><span class="p">)[</span><span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Wind&quot;</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; ($</span><span class="se">\\</span><span class="s">frac{m}{s}$)&quot;</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;mixing_ratio&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mixing_ratio</span><span class="p">()[</span><span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Mixing Ratio&quot;</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (Dimensionless)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;Invalid keyword. which must be a string of an atmospheric parameter included with AMSIMP.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">psurface</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="n">psurface</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;psurface must be a real number within the isobaric boundaries. The value of psurface was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">psurface</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c"># EckertIII projection details.</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">EckertIII</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_global</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">()</span>

            <span class="c"># Contourf plotting.</span>
            <span class="n">minimum</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">maximum</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span><span class="p">,</span> <span class="mf">21</span><span class="p">)</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">add_cyclic_point</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">add_cyclic_point</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">coord</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">contour</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
                <span class="n">lon</span><span class="p">,</span>
                <span class="n">lat</span><span class="p">,</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c"># Add SALT.</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Latitude ($\phi$)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Longitude ($\lambda$)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">data_type</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s">&quot;:00 h)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">data_type</span>
        
            <span class="k">if</span> <span class="n">which</span> <span class="o">!=</span> <span class="s">&quot;surface_temperature&quot;</span> <span class="ow">and</span> <span class="n">which</span> <span class="o">!=</span> <span class="s">&quot;precipitable_water&quot;</span> <span class="ow">and</span> <span class="n">which</span> <span class="o">!=</span> <span class="s">&quot;precipitable_water_vapor&quot;</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">title</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="s">&quot;Pressure Surface = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()[</span><span class="n">indx_psurface</span><span class="p">])</span> <span class="o">+</span><span class="s">&quot;)&quot;</span>
                <span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

            <span class="c"># Colorbar creation.</span>
            <span class="n">colorbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            <span class="n">tick_locator</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mf">15</span><span class="p">)</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">tick_locator</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span>
                <span class="n">data_type</span> <span class="o">+</span> <span class="n">unit</span>
            <span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s">&quot;Visualisations for planetary bodies other than Earth is not currently implemented.&quot;</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">psurface_contourf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s">&quot;air_temperature&quot;</span><span class="p">,</span> <span class="n">central_long</span><span class="o">=</span><span class="mf">352.3079</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots a desired atmospheric process on a contour plot,</span>
<span class="sd">        with the axes being latitude, and pressure surfaces. </span>
<span class="sd">        </span>
<span class="sd">        For the raw data, please see the other methods found in</span>
<span class="sd">        this class.</span>
<span class="sd">        </span>
<span class="sd">        If you would like a particular atmospheric process to</span>
<span class="sd">        be added to this method, either create an issue on</span>
<span class="sd">        GitHub or send an email to support@amsimp.com.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Ensure, which, is a string.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&quot;which must be a string of the name of the atmospheric parameter of interest.&quot;</span>
            <span class="p">)</span>
        
        <span class="c"># Ensure central_long is between 0 and 359.</span>
        <span class="k">if</span> <span class="n">central_long</span> <span class="o">&lt;</span> <span class="mf">0</span> <span class="ow">or</span> <span class="n">central_long</span> <span class="o">&gt;</span> <span class="mf">359</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&quot;central_long must be a real number between 0 and 359. The value of central_long was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">central_long</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c"># Index of the nearest central_long in amsimp.Backend.longtitude_lines()</span>
        <span class="n">indx_long</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">central_long</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="c"># Defines the axes, and the data.</span>
        <span class="n">latitude</span><span class="p">,</span> <span class="n">pressure_surfaces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;temperature&quot;</span> <span class="ow">or</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;air_temperature&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="n">indx_long</span><span class="p">]</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Air Temperature&quot;</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (K)&quot;</span>
        <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;density&quot;</span> <span class="ow">or</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;atmospheric_density&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="n">indx_long</span><span class="p">]</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Atmospheric Density&quot;</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; ($</span><span class="se">\\</span><span class="s">frac{kg}{m^3}$)&quot;</span>
        <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;humidity&quot;</span> <span class="ow">or</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;relative_humidity&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_humidity</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="n">indx_long</span><span class="p">]</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Relative Humidity&quot;</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (%)&quot;</span>
        <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;virtual_temperature&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtual_temperature</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="n">indx_long</span><span class="p">]</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Virtual Temperature&quot;</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (K)&quot;</span>
        <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;vapor_pressure&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vapor_pressure</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="n">indx_long</span><span class="p">]</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Vapor Pressure&quot;</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (hPa)&quot;</span>
        <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;potential_temperature&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_temperature</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="n">indx_long</span><span class="p">]</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Potential Temperature&quot;</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (K)&quot;</span>
        <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;zonal_wind&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind</span><span class="p">()[</span><span class="mf">0</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">indx_long</span><span class="p">]</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Zonal Wind&quot;</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; ($</span><span class="se">\\</span><span class="s">frac{m}{s}$)&quot;</span>
        <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;meridional_wind&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind</span><span class="p">()[</span><span class="mf">1</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">indx_long</span><span class="p">]</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Meridional Wind&quot;</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; ($</span><span class="se">\\</span><span class="s">frac{m}{s}$)&quot;</span>
        <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&quot;mixing_ratio&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mixing_ratio</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="n">indx_long</span><span class="p">]</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="s">&quot;Mixing Ratio&quot;</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s">&quot; (Dimensionless)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&quot;Invalid keyword. which must be a string of an atmospheric parameter included with AMSIMP.&quot;</span>
            <span class="p">)</span>

        <span class="c"># Contourf plotting.</span>
        <span class="n">minimum</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">maximum</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span><span class="p">,</span> <span class="mf">21</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
            <span class="n">latitude</span><span class="p">,</span>
            <span class="n">pressure_surfaces</span><span class="p">,</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Add SALT.</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Latitude ($\phi$)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Pressure (hPa)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
                <span class="n">data_type</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
                <span class="o">+</span> <span class="s">&quot;:00 h, Longitude = &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()[</span><span class="n">indx_long</span><span class="p">],</span> <span class="mf">2</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
                <span class="n">data_type</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span>
                <span class="o">+</span> <span class="s">&quot;Longitude = &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()[</span><span class="n">indx_long</span><span class="p">],</span> <span class="mf">2</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
            <span class="p">)</span>

        <span class="c"># Colorbar creation.</span>
        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">tick_locator</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mf">15</span><span class="p">)</span>
        <span class="n">colorbar</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">tick_locator</span>
        <span class="n">colorbar</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
        <span class="n">colorbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span>
            <span class="n">data_type</span> <span class="o">+</span> <span class="n">unit</span>
        <span class="p">)</span>

        <span class="c"># Average boundary line between the troposphere and the stratosphere.</span>
        <span class="n">troposphere_boundaryline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">troposphere_boundaryline</span><span class="p">()</span>
        <span class="n">avg_tropstratline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">troposphere_boundaryline</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">troposphere_boundaryline</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c"># Plot average boundary line on the contour plot.</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">latitude</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span>
            <span class="n">avg_tropstratline</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s">&quot;dashed&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s">&quot;Troposphere - Stratosphere Boundary Line&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">thickness_contourf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="o">=</span><span class="mf">1000</span><span class="p">,</span> <span class="n">p2</span><span class="o">=</span><span class="mf">500</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots pressure thickness on a contour plot, with the axes being</span>
<span class="sd">        latitude and longitude. This plot is then layed on top of a EckertIII</span>
<span class="sd">        global projection. </span>
<span class="sd">        </span>
<span class="sd">        For the raw data, please use the amsimp.Backend.pressure_thickness()</span>
<span class="sd">        method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planet</span> <span class="o">==</span> <span class="s">&quot;Earth&quot;</span><span class="p">:</span>
            <span class="c"># Defines the axes, and the data.</span>
            <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>

            <span class="n">pressure_thickness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_thickness</span><span class="p">(</span><span class="n">p1</span><span class="o">=</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="o">=</span><span class="n">p2</span><span class="p">)</span>

            <span class="c"># EckertIII projection details.</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">EckertIII</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_global</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">()</span>

            <span class="c"># Contourf plotting.</span>
            <span class="n">minimum</span> <span class="o">=</span> <span class="n">pressure_thickness</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">maximum</span> <span class="o">=</span> <span class="n">pressure_thickness</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span><span class="p">,</span> <span class="mf">21</span><span class="p">)</span>
            <span class="n">pressure_thickness</span><span class="p">,</span> <span class="n">longitude</span> <span class="o">=</span> <span class="n">add_cyclic_point</span><span class="p">(</span>
                <span class="n">pressure_thickness</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="n">longitude</span>
            <span class="p">)</span>
            <span class="n">pressure_thickness</span><span class="p">,</span> <span class="n">latitude</span> <span class="o">=</span> <span class="n">add_cyclic_point</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">pressure_thickness</span><span class="p">),</span> <span class="n">coord</span><span class="o">=</span><span class="n">latitude</span>
            <span class="p">)</span>
            <span class="n">pressure_thickness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">pressure_thickness</span><span class="p">)</span>
            <span class="n">contour</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
                <span class="n">longitude</span><span class="p">,</span>
                <span class="n">latitude</span><span class="p">,</span>
                <span class="n">pressure_thickness</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c"># Index of the rain / snow line</span>
            <span class="n">indx_snowline</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">levels</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mf">5400</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="n">contour</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="n">indx_snowline</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">contour</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="n">indx_snowline</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span> 

            <span class="c"># Add SALT.</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Latitude ($\phi$)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Longitude ($\lambda$)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Pressure Thickness (&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;:00 h&quot;</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Pressure Thickness&quot;</span><span class="p">)</span>

            <span class="c"># Colorbar creation.</span>
            <span class="n">colorbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            <span class="n">tick_locator</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mf">15</span><span class="p">)</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">tick_locator</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span>
                <span class="s">&quot;Pressure Thickness (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; hPa - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; hPa) (m)&quot;</span>
            <span class="p">)</span>

            <span class="c"># Footnote</span>
            <span class="k">if</span> <span class="n">p1</span> <span class="o">==</span> <span class="mf">1000</span> <span class="ow">and</span> <span class="n">p2</span> <span class="o">==</span> <span class="mf">500</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span>
                    <span class="mf">0.99</span><span class="p">,</span>
                    <span class="mf">0.01</span><span class="p">,</span>
                    <span class="s">&quot;Rain / Snow Line is marked by the black line (5,400 m).&quot;</span><span class="p">,</span>
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&quot;right&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s">&quot;Visualisations for planetary bodies other than Earth is not currently implemented.&quot;</span>
            <span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="wind-class">
<h2>Wind Class<a class="headerlink" href="#wind-class" title="Permalink to this headline">¶</a></h2>
<div class="highlight-cython notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">#cython: linetrace=True</span>
<span class="c">#distutils: define_macros=CYTHON_TRACE_NOGIL=1</span>
<span class="c">#cython: language_level=3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">AMSIMP Wind Class. For information about this class is described below.</span>

<span class="sd">Copyright (C) 2020 AMSIMP</span>

<span class="sd">This program is free software: you can redistribute it and/or modify</span>
<span class="sd">it under the terms of the GNU General Public License as published by</span>
<span class="sd">the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">(at your option) any later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful,</span>
<span class="sd">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">GNU General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU General Public License</span>
<span class="sd">along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

<span class="c"># Importing Dependencies</span>
<span class="k">import</span> <span class="nn">os</span>
<span class="k">import</span> <span class="nn">iris</span>
<span class="k">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="k">from</span> <span class="nn">cartopy.util</span> <span class="k">import</span> <span class="n">add_cyclic_point</span>
<span class="k">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="k">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">ticker</span>
<span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">from</span> <span class="nn">amsimp.moist</span> <span class="k">cimport</span> <span class="n">Moist</span>
<span class="k">from</span> <span class="nn">amsimp.moist</span> <span class="k">import</span> <span class="n">Moist</span>
<span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Wind</span><span class="p">(</span><span class="n">Moist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    AMSIMP Wind Class - This class is concerned with calculating numerical</span>
<span class="sd">    values for wind in the troposphere and the stratosphere.</span>

<span class="sd">    Below is a list of the methods included within this class, with a short</span>
<span class="sd">    description of their intended purpose. Please see the relevant class methods</span>
<span class="sd">    for more information.</span>

<span class="sd">    wind ~ generates a NumPy array of the components of wind. The unit of</span>
<span class="sd">    measurement is metres per second.</span>
<span class="sd">    static_stability ~ generates a NumPy array of the the static</span>
<span class="sd">    stability within a vertical profile.</span>
<span class="sd">    verical_motion ~ generates a NumPy array of the vertical motion</span>
<span class="sd">    with the atmosphere, by integrating the isobaric version of the</span>
<span class="sd">    mass continunity equation.</span>
<span class="sd">    wind_contourf ~ generates a vertical profile of geostrophic wind,</span>
<span class="sd">    and outputs this as a contour plot.</span>

<span class="sd">    globe ~ generates a geostrophic wind contour plot, adds wind vectors to</span>
<span class="sd">    that said plot, and overlays both on a Nearside Projection of the Earth.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">static_stability</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of the the static stability within</span>
<span class="sd">        a vertical profile. </span>
<span class="sd">        </span>
<span class="sd">        Static stability is defined as the stability of the</span>
<span class="sd">        atmosphere in hydrostatic equilibrium with respect to vertical</span>
<span class="sd">        displacements.</span>

<span class="sd">        Equation:</span>
<span class="sd">            sigma = - frac{R T}{p theta} frac{partial theta}{partial p}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_temperature</span><span class="p">(</span><span class="n">moist</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">()</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">(</span><span class="n">dim_3d</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">static_stability</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">temperature</span> <span class="o">/</span> <span class="p">(</span><span class="n">pressure</span> <span class="o">*</span> <span class="n">theta</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_p</span><span class="p">(</span>
                <span class="n">parameter</span><span class="o">=</span><span class="n">theta</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">static_stability</span>

    <span class="k">cpdef</span> <span class="kt">tuple</span> <span class="nf">wind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method imports wind data from a GRIB file, which is</span>
<span class="sd">        located in the AMSIMP Initial Conditions Data Repository on GitHub.</span>
<span class="sd">        The data stored within this repo is updated every six hours by amsimp-bot.</span>
<span class="sd">        Following which, it outputs a NumPy array in the shape of</span>
<span class="sd">        (len(pressure_surfaces), len(latitude_lines), len(longitude_lines)).</span>
<span class="sd">        </span>
<span class="sd">        Wind is the flow of gases on a large scale. Wind consists of</span>
<span class="sd">        the bulk movement of air.</span>
<span class="sd">        </span>
<span class="sd">        I strongly recommend storing the output into a variable in order to</span>
<span class="sd">        prevent the need to repeatly download the file. For more information,</span>
<span class="sd">        visit https://github.com/amsimp/initial-conditions.</span>

<span class="sd">        For geostrophic wind, please see the method, wind.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
            <span class="c"># Input data.</span>
            <span class="c"># Zonal.</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_u</span>
            <span class="c"># Meridional.</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_v</span>

            <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Pa</span><span class="p">)</span>
            <span class="c"># Grid.</span>
            <span class="n">grid_points</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s">&#39;pressure&#39;</span><span class="p">,</span>  <span class="n">pressure</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;latitude&#39;</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;longitude&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>                
            <span class="p">]</span>

            <span class="c"># Interpolation</span>
            <span class="c"># Zonal.</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                <span class="n">grid_points</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="c"># Meridional.</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                <span class="n">grid_points</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="c"># Get data.</span>
            <span class="c"># Zonal.</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">data</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="c"># Meridional.</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

            <span class="n">u</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">s</span>
            <span class="n">v</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Zonal.</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_u</span>
            <span class="c"># Meridional.</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_v</span>

        <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">vertical_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of the vertical motion within</span>
<span class="sd">        the atmosphere, by integrating the isobaric version of</span>
<span class="sd">        the mass continunity equation. </span>
<span class="sd">        </span>
<span class="sd">        Typical large-scale vertical motions in the atmosphere</span>
<span class="sd">        are of the order of 0.01 – 0.1 m s−1.</span>

<span class="sd">        Equation:</span>
<span class="sd">            frac{\partial u}{\partial x} + frac{\partial v}{\partial y} = - frac{\partial \omega}{\partial p}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Define variables.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">latitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">())</span><span class="o">.</span><span class="n">value</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">longitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">())</span><span class="o">.</span><span class="n">value</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">(</span><span class="n">dim_3d</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">u</span><span class="p">,</span> <span class="nf">v</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind</span><span class="p">()</span>
        
        <span class="c"># Determine the LHS pf the equation by calculating the derivatives.</span>
        <span class="c"># Change in meridional wind with respect to latitude.</span>
        <span class="n">v_dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_latitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

        <span class="c"># Change in zonal wind with respect to longitude.</span>
        <span class="n">u_dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_longitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>

        <span class="n">LHS</span> <span class="o">=</span> <span class="n">u_dx</span> <span class="o">+</span> <span class="n">v_dy</span>
        <span class="n">LHS</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1</span>

        <span class="c"># Integrate the continunity equation.</span>
        <span class="k">cdef</span> <span class="kt">list</span> <span class="nf">vertical_motion_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">n</span> <span class="o">=</span> <span class="mf">0</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">len_pressure</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
        <span class="k">cdef</span> <span class="nf">omega</span><span class="p">,</span> <span class="nf">omega_unit</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">len_pressure</span><span class="p">:</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">n</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">n</span><span class="o">+</span><span class="mf">2</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">LHS</span><span class="p">[</span><span class="n">p1</span><span class="p">:</span><span class="n">p2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">pressure</span><span class="p">[</span><span class="n">p1</span><span class="p">:</span><span class="n">p2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mf">0</span>
            <span class="p">)</span>
            <span class="n">omega_unit</span> <span class="o">=</span> <span class="n">omega</span><span class="o">.</span><span class="n">unit</span>
            <span class="n">vertical_motion_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">omega</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

            <span class="n">n</span> <span class="o">+=</span> <span class="mf">1</span>

        <span class="c"># Convert list to NumPy array.</span>
        <span class="n">vertical_motion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vertical_motion_list</span><span class="p">)</span>

        <span class="c"># Add units.</span>
        <span class="n">vertical_motion</span> <span class="o">*=</span> <span class="n">omega_unit</span>

        <span class="c"># Ensure the shape is correct.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">vertical_motion</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Unable to determine vertical motion&quot;</span>
                <span class="o">+</span> <span class="s">&quot; at this time. Please contact the developer for futher&quot;</span>
                <span class="o">+</span> <span class="s">&quot; assistance.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vertical_motion</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

    <span class="k">def</span> <span class="nf">globe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">central_lat</span><span class="o">=</span><span class="mf">53.1424</span><span class="p">,</span> <span class="n">central_long</span><span class="o">=</span><span class="mf">352.3079</span><span class="p">,</span> <span class="n">psurface</span><span class="o">=</span><span class="mf">1000</span><span class="p">,</span> <span class="n">which_wind</span><span class="o">=</span><span class="mf">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This particular method adds wind vectors to a contour plot. It also</span>
<span class="sd">        overlays both of these elements onto a Nearside Perspective projection</span>
<span class="sd">        of the Earth.</span>

<span class="sd">        By default, the perspective view is looking directly down at the city</span>
<span class="sd">        of Dublin in the country of Ireland. If which_wind is set to 0, it will</span>
<span class="sd">        plot the non-geostophic wind data, otherwise, if it is set to 1, it will</span>
<span class="sd">        plot the geostrophic wind data.</span>

<span class="sd">        Note:</span>
<span class="sd">        The NumPy method, seterr, is used to suppress a weird RunTime warning</span>
<span class="sd">        error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planet</span> <span class="o">==</span> <span class="s">&quot;Earth&quot;</span><span class="p">:</span>
            <span class="c"># Ensure central_lat is between -90 and 90.</span>
            <span class="k">if</span> <span class="n">central_lat</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">90</span> <span class="ow">or</span> <span class="n">central_lat</span> <span class="o">&gt;</span> <span class="mf">90</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;central_lat must be a real number between -90 and 90. The value of central_lat was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">central_lat</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c"># Ensure central_long is between 0 and 359.</span>
            <span class="k">if</span> <span class="n">central_long</span> <span class="o">&lt;</span> <span class="mf">0</span> <span class="ow">or</span> <span class="n">central_long</span> <span class="o">&gt;</span> <span class="mf">359</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;central_long must be a real number between 0 and 359. The value of central_long was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">central_long</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            
            <span class="c"># Ensure psurface is between 1000 and 1 hPa above sea level.</span>
            <span class="k">if</span> <span class="n">psurface</span> <span class="o">&lt;</span> <span class="mf">1</span> <span class="ow">or</span> <span class="n">psurface</span> <span class="o">&gt;</span> <span class="mf">1000</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;psurface must be a real number between 1 and 1,000. The value of psurface was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">psurface</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            
            <span class="c"># Index of the nearest alt in amsimp.Backend.altitude_level()</span>
            <span class="n">indx_psurface</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">psurface</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

            <span class="c"># Ignore NumPy errors.</span>
            <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s">&quot;ignore&quot;</span><span class="p">)</span>

            <span class="c"># Define the axes, and the data.</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
            <span class="n">longitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>

            <span class="n">wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind</span><span class="p">()</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">wind</span><span class="p">[</span><span class="mf">0</span><span class="p">][</span><span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">wind</span><span class="p">[</span><span class="mf">1</span><span class="p">][</span><span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Wind&quot;</span>

            <span class="n">u_norm</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="mf">2</span> <span class="o">+</span> <span class="n">v</span> <span class="o">**</span> <span class="mf">2</span><span class="p">)</span>
            <span class="n">v_norm</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="mf">2</span> <span class="o">+</span> <span class="n">v</span> <span class="o">**</span> <span class="mf">2</span><span class="p">)</span>

            <span class="n">wind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="mf">2</span> <span class="o">+</span> <span class="n">v</span> <span class="o">**</span> <span class="mf">2</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span>
                <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">NearsidePerspective</span><span class="p">(</span>
                    <span class="n">central_longitude</span><span class="o">=</span><span class="n">central_long</span><span class="p">,</span> <span class="n">central_latitude</span><span class="o">=</span><span class="n">central_lat</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="c"># Add latitudinal and longitudinal grid lines, as well as, </span>
            <span class="c"># coastlines to the globe.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_global</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">()</span>

            <span class="c"># Contour plotting.</span>
            <span class="n">minimum</span> <span class="o">=</span> <span class="n">wind</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">maximum</span> <span class="o">=</span> <span class="n">wind</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span><span class="p">,</span> <span class="mf">21</span><span class="p">)</span>
            <span class="n">wind</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">add_cyclic_point</span><span class="p">(</span><span class="n">wind</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="n">longitude</span><span class="p">)</span>
            <span class="n">wind</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">add_cyclic_point</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">wind</span><span class="p">),</span> <span class="n">coord</span><span class="o">=</span><span class="n">latitude</span><span class="p">)</span>
            <span class="n">wind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">wind</span><span class="p">)</span>
            <span class="n">contourf</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
                <span class="n">lon</span><span class="p">,</span>
                <span class="n">lat</span><span class="p">,</span>
                <span class="n">wind</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
            <span class="p">)</span>
            
            <span class="c"># Reduce density of wind vectors.</span>
            <span class="n">skip_lat</span> <span class="o">=</span> <span class="n">latitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">23</span>
            <span class="n">skip_lat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">skip_lat</span><span class="p">))</span>
            <span class="n">skip_lon</span> <span class="o">=</span> <span class="n">longitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">23</span>
            <span class="n">skip_lon</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">skip_lat</span><span class="p">))</span>

            <span class="c"># Add geostrophic wind vectors.</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span>
                <span class="n">longitude</span><span class="p">[::</span><span class="n">skip_lon</span><span class="p">],</span>
                <span class="n">latitude</span><span class="p">[::</span><span class="n">skip_lat</span><span class="p">],</span>
                <span class="n">u_norm</span><span class="o">.</span><span class="n">value</span><span class="p">[::</span><span class="n">skip_lat</span><span class="p">,</span> <span class="p">::</span><span class="n">skip_lon</span><span class="p">],</span>
                <span class="n">v_norm</span><span class="o">.</span><span class="n">value</span><span class="p">[::</span><span class="n">skip_lat</span><span class="p">,</span> <span class="p">::</span><span class="n">skip_lon</span><span class="p">],</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>   
            <span class="p">)</span>

            <span class="c"># Add SALT.</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Latitude ($\phi$)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Longitude ($\lambda$)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s">&quot;:00 h, Pressure Surface = &quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()[</span><span class="n">indx_psurface</span><span class="p">])</span> <span class="o">+</span><span class="s">&quot;)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span>
                    <span class="o">+</span> <span class="s">&quot;Pressure Surface = &quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()[</span><span class="n">indx_psurface</span><span class="p">])</span> <span class="o">+</span><span class="s">&quot;)&quot;</span>
                <span class="p">)</span>

            <span class="c"># Add colorbar.</span>
            <span class="n">colorbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">contourf</span><span class="p">)</span>
            <span class="n">tick_locator</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mf">15</span><span class="p">)</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">tick_locator</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&quot;Velocity ($</span><span class="se">\\</span><span class="s">frac{m}{s}$)&quot;</span><span class="p">)</span>

            <span class="c"># Footnote</span>
            <span class="k">if</span> <span class="n">which_wind</span> <span class="o">==</span> <span class="mf">1</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span>
                    <span class="mf">0.99</span><span class="p">,</span>
                    <span class="mf">0.01</span><span class="p">,</span>
                    <span class="s">&quot;Note: Geostrophic balance does not hold near the equator.&quot;</span><span class="p">,</span>
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&quot;right&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s">&quot;Visualisations for planetary bodies other than Earth is not currently implemented.&quot;</span>
            <span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="moist-class">
<h2>Moist Class<a class="headerlink" href="#moist-class" title="Permalink to this headline">¶</a></h2>
<div class="highlight-cython notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">#cython: linetrace=True</span>
<span class="c">#distutils: define_macros=CYTHON_TRACE_NOGIL=1</span>
<span class="c">#cython: language_level=3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">AMSIMP Moist Thermodynamics Class. For information about this class is described below.</span>

<span class="sd">Copyright (C) 2020 AMSIMP</span>

<span class="sd">This program is free software: you can redistribute it and/or modify</span>
<span class="sd">it under the terms of the GNU General Public License as published by</span>
<span class="sd">the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">(at your option) any later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful,</span>
<span class="sd">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">GNU General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU General Public License</span>
<span class="sd">along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

<span class="c"># Importing Dependencies</span>
<span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">from</span> <span class="nn">scipy.integrate</span> <span class="k">import</span> <span class="n">quad</span>
<span class="k">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="k">from</span> <span class="nn">cartopy.util</span> <span class="k">import</span> <span class="n">add_cyclic_point</span>
<span class="k">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="k">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">ticker</span>
<span class="k">from</span> <span class="nn">amsimp.backend</span> <span class="k">cimport</span> <span class="n">Backend</span>
<span class="k">from</span> <span class="nn">amsimp.backend</span> <span class="k">import</span> <span class="n">Backend</span>
<span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">from</span> <span class="nn">cpython</span> <span class="k">cimport</span> <span class="nb">bool</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>


<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Moist</span><span class="p">(</span><span class="n">Backend</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    AMSIMP Moist Thermodynamics Class - This class is concerned with incorpating</span>
<span class="sd">    moisture into the atmospheric model. This is done through the utilisation of</span>
<span class="sd">    Mosit Thermodynamics. Atmospheric thermodynamics is the study of heat-to-work</span>
<span class="sd">    transformations (and their reverse) that take place in the earth&#39;s atmosphere</span>
<span class="sd">    and manifest as weather or climate. Atmospheric thermodynamics use the laws</span>
<span class="sd">    of classical thermodynamics, to describe and explain such phenomena as</span>
<span class="sd">    the properties of moist air</span>

<span class="sd">    vapor_pressure ~ generates a NumPy array of saturated vapor pressure.</span>
<span class="sd">    virtual_temperature ~ generates a NumPy array of the virtual temperature.</span>
<span class="sd">    The unit of measurement is Kelvin.</span>

<span class="sd">    density ~ generates a NumPy array of the atmospheric density. The unit of</span>
<span class="sd">    measurement is kilograms per cubic metric.</span>
<span class="sd">    exner_function ~ generates a NumPy array of the Exner function (4). This</span>
<span class="sd">    method has no unit of measurement, i.e. it is dimensionless.</span>
<span class="sd">    mixing_ratio ~ generates a NumPy array of the mixing ratio (water vapor).</span>
<span class="sd">    This method has no unit of measurement, i.e. it is dimensionless.</span>
<span class="sd">    potential_temperature ~ outputs a NumPy array of potential temperature.</span>
<span class="sd">    The unit of measurement is Kelvin.</span>
<span class="sd">    </span>
<span class="sd">    precipitable_water ~ generates a NumPy array of precipitable water</span>
<span class="sd">    vapor. The unit of measurement is millimetres.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">vapor_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of vapor pressure. </span>
<span class="sd">        </span>
<span class="sd">        Vapor pressure, in meteorology, is the partial pressure of water vapor.</span>
<span class="sd">        The partial pressure of water vapor is the pressure that water vapor</span>
<span class="sd">        contributes to the total atmospheric pressure.</span>

<span class="sd">        Equation (Saturated Vapor Pressure):</span>
<span class="sd">            e_s = 6.112 \* \exp((17.67 * T) / (T + 243.15))</span>

<span class="sd">        Equation (Vapor Pressure):</span>
<span class="sd">            e = frac{r_h \* e_s}{100}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Convert temperature in Kelvin to degrees centigrade.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">()</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mf">273.15</span>

        <span class="c"># Saturated water vapor pressure</span>
        <span class="n">sat_vapor_pressure</span> <span class="o">=</span> <span class="mf">0.61121</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="mf">18.678</span> <span class="o">-</span> <span class="p">(</span><span class="n">temperature</span> <span class="o">/</span> <span class="mf">234.5</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">temperature</span> <span class="o">/</span> <span class="p">(</span><span class="mf">257.14</span> <span class="o">+</span> <span class="n">temperature</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c"># Add units of measurement.</span>
        <span class="n">sat_vapor_pressure</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">kPa</span>
        <span class="n">sat_vapor_pressure</span> <span class="o">=</span> <span class="n">sat_vapor_pressure</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">hPa</span><span class="p">)</span>

        <span class="c"># Vapor pressure, accounting for relative humidity.</span>
        <span class="n">vapor_pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_humidity</span><span class="p">()</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">sat_vapor_pressure</span>
        <span class="n">vapor_pressure</span> <span class="o">/=</span> <span class="mf">100</span>

        <span class="k">return</span> <span class="n">vapor_pressure</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">virtual_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of the virtual temperature. </span>
<span class="sd">        </span>
<span class="sd">        The virtual temperature is the temperature at which dry air</span>
<span class="sd">        would have the same density as the moist air, at a given</span>
<span class="sd">        pressure. In other words, two air samples with the same</span>
<span class="sd">        virtual temperature have the same density, regardless</span>
<span class="sd">        of their actual temperature or relative humidity.</span>
<span class="sd">        </span>
<span class="sd">        Equation:</span>
<span class="sd">        T_v = frac{T}{1 - frac{0.378 e}{p}}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">virtual_temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span>
            <span class="mf">1</span> <span class="o">-</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vapor_pressure</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">(</span><span class="n">dim_3d</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1</span> <span class="o">-</span> <span class="mf">0.622</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">virtual_temperature</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of atmospheric pressure utilising the Ideal</span>
<span class="sd">        Gas Law.</span>

<span class="sd">        The atmospheric density is the mass of the atmosphere per unit</span>
<span class="sd">        volume. The ideal gas equation is the equation of state for the</span>
<span class="sd">        atmosphere, and is defined as an equation relating temperature,</span>
<span class="sd">        pressure, and specific volume of a system in theromodynamic</span>
<span class="sd">        equilibrium.</span>

<span class="sd">        Equation:</span>
<span class="sd">            rho = frac{p}{R * T_v}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">pressure_surfaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">(</span><span class="n">dim_3d</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">density</span> <span class="o">=</span> <span class="n">pressure_surfaces</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">virtual_temperature</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>

        <span class="c"># Switch to the appropriate SI units.</span>
        <span class="n">density</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">si</span>
        <span class="k">return</span> <span class="n">density</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">exner_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of the exner function. </span>
<span class="sd">        </span>
<span class="sd">        The Exner function can be viewed as non-dimensionalized pressure.</span>

<span class="sd">        Equation:</span>
<span class="sd">            \Pi = frac{T}{theta}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exner_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtual_temperature</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_temperature</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">exner_function</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">mixing_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of the mixing ratio.</span>

<span class="sd">        The mixing ratio is the ratio of the mass of a variable atmospheric</span>
<span class="sd">        constituent to the mass of dry air. In this particular case, it refers</span>
<span class="sd">        to water vapor.</span>

<span class="sd">        Equation:</span>
<span class="sd">            q = frac{0.622 * e}{p - e}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mixing_ratio</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">0.622</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vapor_pressure</span><span class="p">()</span>
        <span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">(</span><span class="n">dim_3d</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vapor_pressure</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">mixing_ratio</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">potential_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moist</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of potential temperature. </span>
<span class="sd">        </span>
<span class="sd">        The potential temperature of a parcel of fluid at pressure P is the</span>
<span class="sd">        temperature that the parcel would attain if adiabatically brought</span>
<span class="sd">        to a standard reference pressure.</span>

<span class="sd">        Equation:</span>
<span class="sd">            theta = T \* (frac{P}{P_0}) ** (-R / c_p)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Ensure moist is a boolean value.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">moist</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&quot;moist must be a boolean value. The value of moist was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">moist</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c"># Determine whether to calculate wet-bulb potential temperature, or</span>
        <span class="c"># potential temperature.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">temperature</span>
        <span class="k">if</span> <span class="n">moist</span><span class="p">:</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtual_temperature</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>

        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">pressure_surfaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">(</span><span class="n">dim_3d</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">cdef</span> <span class="kt">float</span> <span class="nf">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">value</span>
        <span class="k">cdef</span> <span class="kt">float</span> <span class="nf">c_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_p</span><span class="o">.</span><span class="n">value</span>

        <span class="k">cdef</span> <span class="kt">list</span> <span class="nf">list_potentialtemperature</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">n</span> <span class="o">=</span> <span class="mf">0</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">len_psurfaces</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pressure_surfaces</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">len_psurfaces</span><span class="p">:</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">temperature</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">pressure_surfaces</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">/</span> <span class="n">pressure_surfaces</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">R</span> <span class="o">/</span> <span class="n">c_p</span><span class="p">)</span>
            <span class="p">)</span>
            
            <span class="n">list_potentialtemperature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            
            <span class="n">n</span> <span class="o">+=</span> <span class="mf">1</span>

        <span class="n">potential_temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">list_potentialtemperature</span><span class="p">)</span>
        <span class="n">potential_temperature</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">K</span>
        <span class="k">return</span> <span class="n">potential_temperature</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

    <span class="k">def</span> <span class="nf">__mixing_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">vapor_pressure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is solely utilised for integration in the</span>
<span class="sd">        amsimp.Water.precipitable_water() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.622</span> <span class="o">*</span> <span class="n">vapor_pressure</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">pressure</span> <span class="o">-</span> <span class="n">vapor_pressure</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">y</span>

    <span class="k">cpdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">precipitable_water</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sum_pwv</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of saturated precipitable water vapor.</span>
<span class="sd">        </span>
<span class="sd">        Precipitable water is the total atmospheric water vapor contained in a</span>
<span class="sd">        vertical column of unit cross-sectional area extending between any two</span>
<span class="sd">        specified levels. For a contour plot of this data, please use the</span>
<span class="sd">        amsimp.Water.contourf() method.</span>

<span class="sd">        Equation:</span>
<span class="sd">            PW = frac{1}{rho \* g} \* \int r dp</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Defining some variables.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">(</span><span class="n">dim_3d</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Pa</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="p">(</span><span class="mf">2</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="mf">0</span><span class="p">))</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">vapor_pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vapor_pressure</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Pa</span><span class="p">)</span>
        <span class="n">vapor_pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vapor_pressure</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="mf">2</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="mf">0</span><span class="p">))</span>
        <span class="k">cdef</span> <span class="nf">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>
        <span class="k">cdef</span> <span class="nf">rho_w</span> <span class="o">=</span> <span class="mf">997</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">kg</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">m</span> <span class="o">**</span> <span class="mf">3</span><span class="p">)</span>

        <span class="c"># Integrate the mixing ratio with respect to pressure between the</span>
        <span class="c"># pressure boundaries of p1, and p2.</span>
        <span class="k">cdef</span> <span class="kt">list</span> <span class="nf">list_precipitablewater</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">cdef</span> <span class="kt">list</span> <span class="nf">pwv_lat</span><span class="p">,</span> <span class="nf">pwv_alt</span>
        <span class="k">cdef</span> <span class="kt">tuple</span> <span class="nf">integration_term</span>
        <span class="k">cdef</span> <span class="kt">float</span> <span class="nf">p1</span><span class="p">,</span> <span class="nf">p2</span><span class="p">,</span> <span class="nf">e</span><span class="p">,</span> <span class="nf">Pwv_intergrationterm</span>
        <span class="k">cdef</span> <span class="nf">P_wv</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">len_pressurelong</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">len_pressurelat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pressure</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">len_pressurealt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pressure</span><span class="p">[</span><span class="mf">0</span><span class="p">][</span><span class="mf">0</span><span class="p">])</span> <span class="o">-</span> <span class="mf">1</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">n</span><span class="p">,</span> <span class="nf">k</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mf">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len_pressurelong</span><span class="p">:</span>
            <span class="n">pwv_lat</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">n</span> <span class="o">=</span> <span class="mf">0</span>
            <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">len_pressurelat</span><span class="p">:</span>
                <span class="n">pwv_alt</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">k</span> <span class="o">=</span> <span class="mf">0</span>
                <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">len_pressurealt</span><span class="p">:</span>
                    <span class="n">p1</span> <span class="o">=</span> <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">p2</span> <span class="o">=</span> <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">][</span><span class="n">k</span> <span class="o">+</span> <span class="mf">1</span><span class="p">]</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">vapor_pressure</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">vapor_pressure</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">][</span><span class="n">k</span> <span class="o">+</span> <span class="mf">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2</span>

                    <span class="n">integration_term</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mixing_ratio</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">e</span><span class="p">,))</span>
                    <span class="n">Pwv_intergrationterm</span> <span class="o">=</span> <span class="n">integration_term</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
                    <span class="n">pwv_alt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pwv_intergrationterm</span><span class="p">)</span>

                    <span class="n">k</span> <span class="o">+=</span> <span class="mf">1</span>

                <span class="k">if</span> <span class="n">sum_pwv</span><span class="p">:</span> 
                    <span class="n">P_wv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pwv_alt</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">P_wv</span> <span class="o">=</span> <span class="n">pwv_alt</span>
                
                <span class="n">pwv_lat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_wv</span><span class="p">)</span>                   

                <span class="n">n</span> <span class="o">+=</span> <span class="mf">1</span>
            
            <span class="n">list_precipitablewater</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pwv_lat</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mf">1</span>

        <span class="n">precipitable_water</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">list_precipitablewater</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Pa</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">precipitable_water</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">len_pressurelong</span><span class="p">,</span> <span class="n">len_pressurelat</span><span class="p">):</span>
            <span class="n">precipitable_water</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">precipitable_water</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">precipitable_water</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">precipitable_water</span><span class="p">,</span> <span class="p">(</span><span class="mf">2</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="mf">0</span><span class="p">))</span>

        <span class="c"># Multiplication term by integration.</span>
        <span class="n">precipitable_water</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho_w</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span>

        <span class="n">precipitable_water</span> <span class="o">=</span> <span class="n">precipitable_water</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">mm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">precipitable_water</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="dynamics-class">
<h2>Dynamics Class<a class="headerlink" href="#dynamics-class" title="Permalink to this headline">¶</a></h2>
<div class="highlight-cython notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>   1
   2
   3
   4
   5
   6
   7
   8
   9
  10
  11
  12
  13
  14
  15
  16
  17
  18
  19
  20
  21
  22
  23
  24
  25
  26
  27
  28
  29
  30
  31
  32
  33
  34
  35
  36
  37
  38
  39
  40
  41
  42
  43
  44
  45
  46
  47
  48
  49
  50
  51
  52
  53
  54
  55
  56
  57
  58
  59
  60
  61
  62
  63
  64
  65
  66
  67
  68
  69
  70
  71
  72
  73
  74
  75
  76
  77
  78
  79
  80
  81
  82
  83
  84
  85
  86
  87
  88
  89
  90
  91
  92
  93
  94
  95
  96
  97
  98
  99
 100
 101
 102
 103
 104
 105
 106
 107
 108
 109
 110
 111
 112
 113
 114
 115
 116
 117
 118
 119
 120
 121
 122
 123
 124
 125
 126
 127
 128
 129
 130
 131
 132
 133
 134
 135
 136
 137
 138
 139
 140
 141
 142
 143
 144
 145
 146
 147
 148
 149
 150
 151
 152
 153
 154
 155
 156
 157
 158
 159
 160
 161
 162
 163
 164
 165
 166
 167
 168
 169
 170
 171
 172
 173
 174
 175
 176
 177
 178
 179
 180
 181
 182
 183
 184
 185
 186
 187
 188
 189
 190
 191
 192
 193
 194
 195
 196
 197
 198
 199
 200
 201
 202
 203
 204
 205
 206
 207
 208
 209
 210
 211
 212
 213
 214
 215
 216
 217
 218
 219
 220
 221
 222
 223
 224
 225
 226
 227
 228
 229
 230
 231
 232
 233
 234
 235
 236
 237
 238
 239
 240
 241
 242
 243
 244
 245
 246
 247
 248
 249
 250
 251
 252
 253
 254
 255
 256
 257
 258
 259
 260
 261
 262
 263
 264
 265
 266
 267
 268
 269
 270
 271
 272
 273
 274
 275
 276
 277
 278
 279
 280
 281
 282
 283
 284
 285
 286
 287
 288
 289
 290
 291
 292
 293
 294
 295
 296
 297
 298
 299
 300
 301
 302
 303
 304
 305
 306
 307
 308
 309
 310
 311
 312
 313
 314
 315
 316
 317
 318
 319
 320
 321
 322
 323
 324
 325
 326
 327
 328
 329
 330
 331
 332
 333
 334
 335
 336
 337
 338
 339
 340
 341
 342
 343
 344
 345
 346
 347
 348
 349
 350
 351
 352
 353
 354
 355
 356
 357
 358
 359
 360
 361
 362
 363
 364
 365
 366
 367
 368
 369
 370
 371
 372
 373
 374
 375
 376
 377
 378
 379
 380
 381
 382
 383
 384
 385
 386
 387
 388
 389
 390
 391
 392
 393
 394
 395
 396
 397
 398
 399
 400
 401
 402
 403
 404
 405
 406
 407
 408
 409
 410
 411
 412
 413
 414
 415
 416
 417
 418
 419
 420
 421
 422
 423
 424
 425
 426
 427
 428
 429
 430
 431
 432
 433
 434
 435
 436
 437
 438
 439
 440
 441
 442
 443
 444
 445
 446
 447
 448
 449
 450
 451
 452
 453
 454
 455
 456
 457
 458
 459
 460
 461
 462
 463
 464
 465
 466
 467
 468
 469
 470
 471
 472
 473
 474
 475
 476
 477
 478
 479
 480
 481
 482
 483
 484
 485
 486
 487
 488
 489
 490
 491
 492
 493
 494
 495
 496
 497
 498
 499
 500
 501
 502
 503
 504
 505
 506
 507
 508
 509
 510
 511
 512
 513
 514
 515
 516
 517
 518
 519
 520
 521
 522
 523
 524
 525
 526
 527
 528
 529
 530
 531
 532
 533
 534
 535
 536
 537
 538
 539
 540
 541
 542
 543
 544
 545
 546
 547
 548
 549
 550
 551
 552
 553
 554
 555
 556
 557
 558
 559
 560
 561
 562
 563
 564
 565
 566
 567
 568
 569
 570
 571
 572
 573
 574
 575
 576
 577
 578
 579
 580
 581
 582
 583
 584
 585
 586
 587
 588
 589
 590
 591
 592
 593
 594
 595
 596
 597
 598
 599
 600
 601
 602
 603
 604
 605
 606
 607
 608
 609
 610
 611
 612
 613
 614
 615
 616
 617
 618
 619
 620
 621
 622
 623
 624
 625
 626
 627
 628
 629
 630
 631
 632
 633
 634
 635
 636
 637
 638
 639
 640
 641
 642
 643
 644
 645
 646
 647
 648
 649
 650
 651
 652
 653
 654
 655
 656
 657
 658
 659
 660
 661
 662
 663
 664
 665
 666
 667
 668
 669
 670
 671
 672
 673
 674
 675
 676
 677
 678
 679
 680
 681
 682
 683
 684
 685
 686
 687
 688
 689
 690
 691
 692
 693
 694
 695
 696
 697
 698
 699
 700
 701
 702
 703
 704
 705
 706
 707
 708
 709
 710
 711
 712
 713
 714
 715
 716
 717
 718
 719
 720
 721
 722
 723
 724
 725
 726
 727
 728
 729
 730
 731
 732
 733
 734
 735
 736
 737
 738
 739
 740
 741
 742
 743
 744
 745
 746
 747
 748
 749
 750
 751
 752
 753
 754
 755
 756
 757
 758
 759
 760
 761
 762
 763
 764
 765
 766
 767
 768
 769
 770
 771
 772
 773
 774
 775
 776
 777
 778
 779
 780
 781
 782
 783
 784
 785
 786
 787
 788
 789
 790
 791
 792
 793
 794
 795
 796
 797
 798
 799
 800
 801
 802
 803
 804
 805
 806
 807
 808
 809
 810
 811
 812
 813
 814
 815
 816
 817
 818
 819
 820
 821
 822
 823
 824
 825
 826
 827
 828
 829
 830
 831
 832
 833
 834
 835
 836
 837
 838
 839
 840
 841
 842
 843
 844
 845
 846
 847
 848
 849
 850
 851
 852
 853
 854
 855
 856
 857
 858
 859
 860
 861
 862
 863
 864
 865
 866
 867
 868
 869
 870
 871
 872
 873
 874
 875
 876
 877
 878
 879
 880
 881
 882
 883
 884
 885
 886
 887
 888
 889
 890
 891
 892
 893
 894
 895
 896
 897
 898
 899
 900
 901
 902
 903
 904
 905
 906
 907
 908
 909
 910
 911
 912
 913
 914
 915
 916
 917
 918
 919
 920
 921
 922
 923
 924
 925
 926
 927
 928
 929
 930
 931
 932
 933
 934
 935
 936
 937
 938
 939
 940
 941
 942
 943
 944
 945
 946
 947
 948
 949
 950
 951
 952
 953
 954
 955
 956
 957
 958
 959
 960
 961
 962
 963
 964
 965
 966
 967
 968
 969
 970
 971
 972
 973
 974
 975
 976
 977
 978
 979
 980
 981
 982
 983
 984
 985
 986
 987
 988
 989
 990
 991
 992
 993
 994
 995
 996
 997
 998
 999
1000
1001
1002
1003
1004
1005
1006
1007
1008
1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026
1027
1028
1029
1030
1031
1032
1033
1034
1035
1036
1037
1038
1039
1040
1041
1042
1043
1044
1045
1046
1047
1048
1049
1050
1051
1052
1053
1054
1055
1056
1057
1058
1059
1060
1061
1062
1063
1064
1065
1066
1067
1068
1069
1070
1071
1072
1073
1074
1075
1076
1077
1078
1079
1080
1081
1082
1083
1084
1085
1086
1087
1088
1089
1090
1091
1092
1093
1094
1095
1096
1097
1098
1099
1100
1101
1102
1103
1104
1105
1106
1107
1108
1109
1110
1111
1112
1113
1114
1115
1116
1117
1118
1119
1120
1121
1122
1123
1124
1125
1126
1127
1128
1129
1130
1131
1132
1133
1134
1135
1136
1137
1138
1139
1140
1141
1142
1143
1144
1145
1146
1147
1148
1149
1150
1151
1152
1153
1154
1155
1156
1157
1158
1159
1160
1161
1162
1163
1164
1165
1166
1167
1168
1169
1170
1171
1172
1173
1174
1175
1176
1177
1178
1179
1180
1181
1182
1183
1184
1185
1186
1187
1188
1189
1190
1191
1192
1193
1194
1195
1196
1197
1198
1199
1200
1201
1202
1203
1204
1205
1206
1207
1208
1209
1210
1211
1212
1213
1214
1215
1216
1217
1218
1219
1220
1221
1222
1223
1224
1225
1226
1227
1228
1229
1230
1231
1232
1233
1234
1235
1236
1237
1238
1239
1240
1241
1242
1243
1244
1245
1246
1247
1248
1249
1250
1251
1252
1253
1254
1255
1256
1257
1258
1259
1260
1261
1262
1263
1264
1265
1266
1267
1268
1269
1270
1271
1272
1273
1274
1275
1276
1277
1278
1279
1280
1281
1282
1283
1284
1285
1286
1287
1288
1289
1290
1291
1292
1293
1294
1295
1296
1297
1298
1299
1300
1301
1302
1303
1304
1305
1306
1307
1308
1309
1310
1311
1312
1313
1314
1315
1316
1317
1318
1319
1320
1321
1322
1323
1324
1325
1326
1327
1328
1329
1330
1331
1332
1333
1334
1335
1336
1337
1338
1339
1340
1341
1342
1343
1344
1345
1346
1347
1348
1349
1350
1351
1352
1353
1354
1355
1356
1357
1358
1359
1360
1361
1362
1363
1364
1365
1366
1367
1368
1369
1370
1371
1372
1373
1374
1375
1376
1377
1378
1379
1380
1381
1382
1383
1384
1385
1386
1387
1388
1389
1390
1391
1392
1393
1394
1395
1396
1397
1398
1399
1400
1401
1402
1403
1404
1405
1406
1407
1408
1409
1410
1411
1412
1413
1414
1415
1416
1417
1418
1419
1420
1421
1422
1423
1424
1425
1426
1427
1428
1429
1430
1431
1432
1433
1434
1435
1436
1437
1438
1439
1440
1441
1442
1443
1444
1445
1446
1447
1448
1449
1450
1451
1452
1453
1454
1455
1456
1457
1458
1459
1460
1461
1462
1463
1464
1465
1466
1467
1468
1469
1470
1471
1472
1473
1474
1475
1476
1477
1478
1479
1480
1481</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">#cython: linetrace=True</span>
<span class="c">#distutils: define_macros=CYTHON_TRACE_NOGIL=1</span>
<span class="c">#cython: language_level=3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">AMSIMP Recurrent Neural Network and Dynamics Class. For information about</span>
<span class="sd">this class is described below.</span>

<span class="sd">Copyright (C) 2020 AMSIMP</span>

<span class="sd">This program is free software: you can redistribute it and/or modify</span>
<span class="sd">it under the terms of the GNU General Public License as published by</span>
<span class="sd">the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">(at your option) any later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful,</span>
<span class="sd">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">GNU General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU General Public License</span>
<span class="sd">along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

<span class="c"># Importing Dependencies</span>
<span class="k">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">datetime</span>
<span class="k">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="k">from</span> <span class="nn">sklearn.preprocessing</span> <span class="k">import</span> <span class="n">MinMaxScaler</span>
<span class="k">from</span> <span class="nn">tensorflow.keras.models</span> <span class="k">import</span> <span class="n">Sequential</span>
<span class="k">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="k">import</span> <span class="n">LSTM</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">RepeatVector</span><span class="p">,</span> <span class="n">TimeDistributed</span>
<span class="k">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="k">import</span> <span class="n">Bidirectional</span>
<span class="k">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="k">import</span> <span class="n">Adam</span>
<span class="k">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="k">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="k">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">style</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">gridspec</span>
<span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">constant</span>
<span class="k">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="k">from</span> <span class="nn">cartopy.util</span> <span class="k">import</span> <span class="n">add_cyclic_point</span>
<span class="k">from</span> <span class="nn">cpython</span> <span class="k">cimport</span> <span class="nb">bool</span>
<span class="k">from</span> <span class="nn">amsimp.wind</span> <span class="k">cimport</span> <span class="n">Wind</span>
<span class="k">from</span> <span class="nn">amsimp.wind</span> <span class="k">import</span> <span class="n">Wind</span>
<span class="k">from</span> <span class="nn">astropy.units.quantity</span> <span class="k">import</span> <span class="n">Quantity</span>
<span class="k">import</span> <span class="nn">iris</span>
<span class="k">from</span> <span class="nn">iris.coords</span> <span class="k">import</span> <span class="n">DimCoord</span><span class="p">,</span> <span class="n">AuxCoord</span>
<span class="k">from</span> <span class="nn">iris.cube</span> <span class="k">import</span> <span class="n">Cube</span><span class="p">,</span> <span class="n">CubeList</span>
<span class="k">from</span> <span class="nn">iris</span> <span class="k">import</span> <span class="n">save</span>
<span class="k">from</span> <span class="nn">progress.bar</span> <span class="k">import</span> <span class="n">IncrementalBar</span>

<span class="c"># -----------------------------------------------------------------------------------------#</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">RNN</span><span class="p">(</span><span class="n">Wind</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    AMSIMP Recurrent Neural Network Class - This class is concerned with</span>
<span class="sd">    determining the evolution of the state of the atmosphere through</span>
<span class="sd">    the utilisation of a recurrent neural network. Weather forecasting</span>
<span class="sd">    has traditionally been done by physical models of the atmosphere,</span>
<span class="sd">    which are unstable to perturbations, and thus are inaccurate for</span>
<span class="sd">    large periods of time. Since machine learning techniques are more</span>
<span class="sd">    robust to perturbations, it would be logical to combine a neural network</span>
<span class="sd">    with a physical model. Weather forecasting is a sequential data problem,</span>
<span class="sd">    therefore, a recurrent neural network is the most suitable option for</span>
<span class="sd">    this task. For this particular version of the software, the</span>
<span class="sd">    recurrent neural network will be trained solely on temperature and</span>
<span class="sd">    relative humidity data. Geopotential height will be added in a future release.</span>
<span class="sd">    A seed is set in order to ensure reproducibility.</span>

<span class="sd">    Below is a list of the methods included within this class, with a short</span>
<span class="sd">    description of their intended purpose. Please see the relevant class methods</span>
<span class="sd">    for more information:</span>

<span class="sd">    download_historical_data ~ generates a NumPy array of the previous state</span>
<span class="sd">    of the atmosphere. The number of days of data which is generated can</span>
<span class="sd">    be specified through the utilisation of the parameter, data_size, when</span>
<span class="sd">    the class is initialised.</span>
<span class="sd">    standardise_data ~ generates a NumPy array which standardises the data</span>
<span class="sd">    generated by the download_historical_data method. </span>
<span class="sd">    preprocess_data ~ generates the training dataset for the recurrent</span>
<span class="sd">    neural network.</span>
<span class="sd">    model_prediction ~ generates a NumPy array of evolution of the</span>
<span class="sd">    future state of the atmosphere. This is the prediction generated</span>
<span class="sd">    by the recurrent neural network by training on the generated and</span>
<span class="sd">    preprocessed training data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Feature Scaling </span>
    <span class="n">temp_sc</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">))</span>
    <span class="n">rh_sc</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">))</span>
    <span class="n">height_sc</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">))</span>

    <span class="c"># Ensure reproducibility.</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mf">13</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">download_historical_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of the previous state of the atmosphere.</span>
<span class="sd">        The number of days of data which is generated can be specified</span>
<span class="sd">        through the utilisation of the parameter, data_size, when the</span>
<span class="sd">        class is initialised.</span>

<span class="sd">        This data is retrieved from the historical dataset contained</span>
<span class="sd">        on the AMSIMP Initial Atmospheric Conditions Repository.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Folder containing historical data on GitHub.</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="s">&quot;https://github.com/amsimp/initial-conditions/raw/master/initial_conditions/&quot;</span>

        <span class="c"># Data lists.</span>
        <span class="c"># Temperature.</span>
        <span class="k">cdef</span> <span class="kt">list</span> <span class="nf">T_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Geopotential Height.</span>
        <span class="k">cdef</span> <span class="kt">list</span> <span class="nf">geo_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Relative Humidity.</span>
        <span class="k">cdef</span> <span class="kt">list</span> <span class="nf">rh_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Define variable types.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">T</span><span class="p">,</span> <span class="nf">height</span><span class="p">,</span> <span class="nf">rh</span>

        <span class="c"># Beginning date of the dataset.</span>
        <span class="k">cdef</span> <span class="nf">date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">data_size</span><span class="p">)</span>

        <span class="c"># Download progresss.</span>
        <span class="n">max_bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_size</span> <span class="o">*</span> <span class="mf">4</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">IncrementalBar</span><span class="p">(</span><span class="s">&#39;Downloading Historical Data&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">max_bar</span><span class="p">)</span>

        <span class="c"># Check if the parameter, input_data, is set to True.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s">&quot;Currently, it is not possible to train the neural network on user defined datasets.&quot;</span>
            <span class="p">)</span> 

        <span class="c"># Remove initial conditions file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;initial_conditions.nc&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_bar</span><span class="p">):</span>
            <span class="c"># Configure the Wind class, so, that it aligns with the</span>
            <span class="c"># paramaters defined by the user.</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Wind</span><span class="p">(</span>
                <span class="n">delta_latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_latitude</span><span class="p">,</span>
                <span class="n">delta_longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_longitude</span><span class="p">,</span>
                <span class="n">input_date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c"># Redefine NumPy arrays.</span>
            <span class="c"># Geopotential Height.</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">geopotential_height</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="c"># Temperature.</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">temperature</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="c"># Relative Humidity.</span>
            <span class="n">rh</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">relative_humidity</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
            <span class="n">rh</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="c"># Append to list.</span>
            <span class="c"># Geopotential Height.</span>
            <span class="n">geo_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
            <span class="c"># Temperature.</span>
            <span class="n">T_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
            <span class="c"># Relative Humidity.</span>
            <span class="n">rh_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rh</span><span class="p">)</span>

            <span class="c"># Add six hours to date to get the next dataset.</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=+</span><span class="mf">6</span><span class="p">)</span>

            <span class="c"># Remove download file.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;initial_conditions.nc&quot;</span><span class="p">)</span>

            <span class="c"># Increment progress bar.</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

        <span class="c"># Convert lists to NumPy arrays.</span>
        <span class="c"># Geopotential Height.</span>
        <span class="n">geopotential_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">geo_list</span><span class="p">)</span>
        <span class="c"># Temperature.</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">T_list</span><span class="p">)</span>
        <span class="c"># Relative Humidity.</span>
        <span class="n">relative_humidity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rh_list</span><span class="p">)</span>

        <span class="c"># Finish bar.</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

        <span class="c"># Output.s</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">relative_humidity</span><span class="p">,</span> <span class="n">geopotential_height</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>        

    <span class="k">def</span> <span class="nf">standardise_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array which standardises the data</span>
<span class="sd">        generated by the download_historical_data method. It is important</span>
<span class="sd">        to scale features before training a neural network.</span>
<span class="sd">        </span>
<span class="sd">        Normalisation is a common way of doing this scaling by</span>
<span class="sd">        subtracting the mean and dividing by the standard deviation</span>
<span class="sd">        of each feature. In order for the most optimal performance,</span>
<span class="sd">        the method ``MinMaxScaler&quot; from the library, scikit-learn,</span>
<span class="sd">        is utilised within the software.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Define atmospheric parameters.</span>
        <span class="n">historical_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_historical_data</span><span class="p">()</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">historical_data</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="n">relative_humidity</span> <span class="o">=</span> <span class="n">historical_data</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
        <span class="n">geopotential_height</span> <span class="o">=</span> <span class="n">historical_data</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>

        <span class="c"># Standardise the data.</span>
        <span class="c"># Temperature.</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_sc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
        <span class="c"># Relative Humidity.</span>
        <span class="n">relative_humidity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rh_sc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">relative_humidity</span><span class="p">)</span>
        <span class="c"># Geopotential Height.</span>
        <span class="n">geopotential_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height_sc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">geopotential_height</span><span class="p">)</span>

        <span class="c"># Output.</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">relative_humidity</span><span class="p">,</span> <span class="n">geopotential_height</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">preprocess_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">past_history</span><span class="p">,</span> <span class="n">future_target</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the training dataset for the recurrent neural network.</span>

<span class="sd">        The data set in question is updated every six hours by the National Oceanic</span>
<span class="sd">        and Atmospheric Administration. This means for a single day,</span>
<span class="sd">        there will be four observations. The goal for the software will be to,</span>
<span class="sd">        first predict the relevant atmospheric parameter in seven days time</span>
<span class="sd">        given the last thirty days of data and combine this RNN prediction with the</span>
<span class="sd">        physical model prediction in an attempt to make a more accurate prediction</span>
<span class="sd">        overall. In order to make such predictions, it is necessary to create a</span>
<span class="sd">        window of the last 120 (30 x 4) observations to train the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)):</span>
            <span class="c"># Find the end.</span>
            <span class="n">end_ix</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">past_history</span>
            <span class="n">out_end_ix</span> <span class="o">=</span> <span class="n">end_ix</span> <span class="o">+</span> <span class="n">future_target</span>
            
            <span class="c"># Determine if we are beyond the dataset.</span>
            <span class="k">if</span> <span class="n">out_end_ix</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
                <span class="k">break</span>
            
            <span class="c"># Gather the input and output components.</span>
            <span class="n">seq_x</span><span class="p">,</span> <span class="n">seq_y</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">end_ix</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dataset</span><span class="p">[</span><span class="n">end_ix</span><span class="p">:</span><span class="n">out_end_ix</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c"># Append to list.</span>
            <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_x</span><span class="p">)</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_y</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">model_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a NumPy array of evolution of the future state of the atmosphere.</span>

<span class="sd">        This is the prediction generated by the recurrent neural network by training</span>
<span class="sd">        on the generated and preprocessed training data. Please see the other</span>
<span class="sd">        methods within this class for preprocessing information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Dataset.</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardise_data</span><span class="p">()</span>

        <span class="c"># Temperature.</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="c"># Relative Humidity.</span>
        <span class="n">relative_humidity</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
        <span class="c"># Geopotential Height.</span>
        <span class="n">geopotential_height</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>

        <span class="c"># The network is shown data from the last 15 days.</span>
        <span class="n">past_history</span> <span class="o">=</span> <span class="mf">20</span> <span class="o">*</span> <span class="mf">4</span>

        <span class="c"># The network predicts the next 7 days worth of steps.</span>
        <span class="n">future_target</span> <span class="o">=</span> <span class="mf">7</span> <span class="o">*</span> <span class="mf">4</span>

        <span class="c"># The dataset is preprocessed.</span>
        <span class="c"># Temperature.</span>
        <span class="n">x_temp</span><span class="p">,</span> <span class="n">y_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_data</span><span class="p">(</span>
            <span class="n">temperature</span><span class="p">,</span> <span class="n">past_history</span><span class="p">,</span> <span class="n">future_target</span>
        <span class="p">)</span>
        <span class="c"># Relative Humidity.</span>
        <span class="n">x_rh</span><span class="p">,</span> <span class="n">y_rh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_data</span><span class="p">(</span>
            <span class="n">relative_humidity</span><span class="p">,</span> <span class="n">past_history</span><span class="p">,</span> <span class="n">future_target</span>
        <span class="p">)</span>
        <span class="c"># Geopotential Height.</span>
        <span class="n">x_height</span><span class="p">,</span> <span class="n">y_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_data</span><span class="p">(</span>
            <span class="n">geopotential_height</span><span class="p">,</span> <span class="n">past_history</span><span class="p">,</span> <span class="n">future_target</span>
        <span class="p">)</span>

        <span class="c"># Number of features.</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">x_temp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>

        <span class="c"># Create, and train models.</span>
        <span class="c"># Temperature model.</span>
        <span class="c"># Optimiser.</span>
        <span class="n">opt_temp</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">clipvalue</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="c"># Create.</span>
        <span class="n">temp_model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
        <span class="n">temp_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">LSTM</span><span class="p">(</span>
                <span class="mf">400</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">past_history</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">temp_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">RepeatVector</span><span class="p">(</span><span class="n">future_target</span><span class="p">))</span>
        <span class="n">temp_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mf">400</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">temp_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mf">400</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">&#39;relu&#39;</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">temp_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mf">400</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">&#39;relu&#39;</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">temp_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">features</span><span class="p">)))</span>
        <span class="n">temp_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">opt_temp</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s">&#39;mse&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;mean_absolute_error&#39;</span><span class="p">])</span>
        <span class="c"># Train.</span>
        <span class="n">temp_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">x_temp</span><span class="p">,</span> <span class="n">y_temp</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mf">20</span>
        <span class="p">)</span>

        <span class="c"># Relative Humidity model.</span>
        <span class="c"># Optimiser.</span>
        <span class="n">opt_rh</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">clipvalue</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="c"># Create.</span>
        <span class="n">rh_model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
        <span class="n">rh_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">LSTM</span><span class="p">(</span>
                <span class="mf">400</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">past_history</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">rh_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">RepeatVector</span><span class="p">(</span><span class="n">future_target</span><span class="p">))</span>
        <span class="n">rh_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mf">400</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">rh_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mf">400</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">&#39;relu&#39;</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">rh_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mf">400</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">&#39;relu&#39;</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">rh_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">features</span><span class="p">)))</span>
        <span class="n">rh_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">opt_rh</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s">&#39;mse&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;mean_absolute_error&#39;</span><span class="p">])</span>
        <span class="c"># Train.</span>
        <span class="n">rh_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">x_rh</span><span class="p">,</span> <span class="n">y_rh</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mf">20</span>
        <span class="p">)</span>

        <span class="c"># Geopotential height model.</span>
        <span class="c"># Optimiser.</span>
        <span class="n">opt_height</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">clipvalue</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="c"># Create.</span>
        <span class="n">height_model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
        <span class="n">height_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">LSTM</span><span class="p">(</span>
                <span class="mf">400</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">past_history</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">height_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">RepeatVector</span><span class="p">(</span><span class="n">future_target</span><span class="p">))</span>
        <span class="n">height_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mf">400</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">height_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mf">400</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">&#39;relu&#39;</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">height_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mf">400</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">&#39;relu&#39;</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">height_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">features</span><span class="p">)))</span>
        <span class="n">height_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">opt_height</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s">&#39;mse&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;mean_absolute_error&#39;</span><span class="p">])</span>
        <span class="c"># Train.</span>
        <span class="n">height_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">x_height</span><span class="p">,</span> <span class="n">y_height</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mf">20</span>
        <span class="p">)</span>

        <span class="c"># Prediction.</span>
        <span class="c"># Set up inputs.</span>
        <span class="n">predict_temp_input</span> <span class="o">=</span> <span class="n">temperature</span><span class="p">[</span><span class="o">-</span><span class="n">past_history</span><span class="p">:,</span> <span class="p">:]</span>
        <span class="n">predict_temp_input</span> <span class="o">=</span> <span class="n">predict_temp_input</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="mf">1</span><span class="p">,</span> <span class="n">predict_temp_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">predict_temp_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">predict_rh_input</span> <span class="o">=</span> <span class="n">relative_humidity</span><span class="p">[</span><span class="o">-</span><span class="n">past_history</span><span class="p">:,</span> <span class="p">:]</span>
        <span class="n">predict_rh_input</span> <span class="o">=</span> <span class="n">predict_rh_input</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="mf">1</span><span class="p">,</span> <span class="n">predict_rh_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">predict_rh_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">predict_height_input</span> <span class="o">=</span> <span class="n">geopotential_height</span><span class="p">[</span><span class="o">-</span><span class="n">past_history</span><span class="p">:,</span> <span class="p">:]</span>
        <span class="n">predict_height_input</span> <span class="o">=</span> <span class="n">predict_height_input</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="mf">1</span><span class="p">,</span> <span class="n">predict_height_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">predict_height_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c"># Make predictions.</span>
        <span class="n">predict_temp</span> <span class="o">=</span> <span class="n">temp_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">predict_temp_input</span><span class="p">)</span>
        <span class="n">predict_temp</span> <span class="o">=</span> <span class="n">predict_temp</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="n">predict_rh</span> <span class="o">=</span> <span class="n">rh_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">predict_rh_input</span><span class="p">)</span>
        <span class="n">predict_rh</span> <span class="o">=</span> <span class="n">predict_rh</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="n">predict_height</span> <span class="o">=</span> <span class="n">rh_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">predict_height_input</span><span class="p">)</span>
        <span class="n">predict_height</span> <span class="o">=</span> <span class="n">predict_height</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>

        <span class="c"># Invert normalisation.</span>
        <span class="n">predict_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_sc</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">predict_temp</span><span class="p">)</span>
        <span class="n">predict_rh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rh_sc</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">predict_rh</span><span class="p">)</span>
        <span class="n">predict_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rh_sc</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">predict_height</span><span class="p">)</span>

        <span class="c"># Reshape into 3d arrays.</span>
        <span class="c"># Dimensions.</span>
        <span class="n">len_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predict_temp</span><span class="p">)</span>
        <span class="n">len_pressure</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">())</span>
        <span class="n">len_lat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">())</span>
        <span class="n">len_lon</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">())</span>
        <span class="c"># Reshape.</span>
        <span class="n">predict_temp</span> <span class="o">=</span> <span class="n">predict_temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">len_time</span><span class="p">,</span> <span class="n">len_pressure</span><span class="p">,</span> <span class="n">len_lat</span><span class="p">,</span> <span class="n">len_lon</span><span class="p">)</span>
        <span class="n">predict_rh</span> <span class="o">=</span> <span class="n">predict_rh</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">len_time</span><span class="p">,</span> <span class="n">len_pressure</span><span class="p">,</span> <span class="n">len_lat</span><span class="p">,</span> <span class="n">len_lon</span><span class="p">)</span>
        <span class="n">predict_height</span> <span class="o">=</span> <span class="n">predict_height</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">len_time</span><span class="p">,</span> <span class="n">len_pressure</span><span class="p">,</span> <span class="n">len_lat</span><span class="p">,</span> <span class="n">len_lon</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predict_temp</span><span class="p">,</span> <span class="n">predict_rh</span><span class="p">,</span> <span class="n">predict_height</span>

<span class="k">cdef</span> <span class="k">class</span> <span class="nf">Dynamics</span><span class="p">(</span><span class="n">RNN</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    AMSIMP Dynamics Class - Also, known as Motus Aeris @ AMSIMP. This class</span>
<span class="sd">    generates a simulation of tropospheric and stratsopheric dynamics. </span>
<span class="sd">    Predictions are made by numerically solving the isobaric version of the</span>
<span class="sd">    Primitive Equations (they are coupled set of nonlinear PDEs). The initial conditions</span>
<span class="sd">    are defined in the class methods of Water, Moist, and Backend. For more information</span>
<span class="sd">    on the initial conditions, please see those classes.</span>
<span class="sd">    </span>
<span class="sd">    Below is a list of the methods included within this class, with a short</span>
<span class="sd">    description of their intended purpose. Please see the relevant class methods</span>
<span class="sd">    for more information.</span>

<span class="sd">    forecast_period ~ generates the period of time over which the forecast will</span>
<span class="sd">    be generated for. Please also note that this method also outputs the change in time</span>
<span class="sd">    used. This is used in the prognostic equations. </span>
<span class="sd">    simulate ~ generates a simulation of tropospheric and stratsopheric dynamics.</span>
<span class="sd">    visualise ~ please explain here.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="nb">int</span> <span class="n">delta_latitude</span><span class="o">=</span><span class="mf">5</span><span class="p">,</span>
            <span class="nb">int</span> <span class="n">delta_longitude</span><span class="o">=</span><span class="mf">5</span><span class="p">,</span>
            <span class="n">forecast_length</span><span class="o">=</span><span class="mf">72</span><span class="p">,</span> 
            <span class="n">delta_t</span><span class="o">=</span><span class="mf">2</span><span class="p">,</span> 
            <span class="nb">bool</span> <span class="n">ai</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
            <span class="n">data_size</span><span class="o">=</span><span class="mf">150</span><span class="p">,</span> 
            <span class="n">epochs</span><span class="o">=</span><span class="mf">200</span><span class="p">,</span> 
            <span class="n">input_date</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
            <span class="nb">bool</span> <span class="n">input_data</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">psurfaces</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">lat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">lon</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
            <span class="n">temp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
            <span class="n">rh</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
            <span class="n">u</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
            <span class="n">v</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="nb">dict</span> <span class="n">constants</span><span class="o">=</span><span class="p">{</span>
                <span class="s">&quot;sidereal_day&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">23</span> <span class="o">+</span> <span class="p">(</span><span class="mf">56</span> <span class="o">/</span> <span class="mf">60</span><span class="p">))</span> <span class="o">*</span> <span class="mf">3600</span><span class="p">,</span>
                <span class="s">&quot;angular_rotation_rate&quot;</span><span class="p">:</span> <span class="p">((</span><span class="mf">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mf">23</span> <span class="o">+</span> <span class="p">(</span><span class="mf">56</span> <span class="o">/</span> <span class="mf">60</span><span class="p">))</span> <span class="o">*</span> <span class="mf">3600</span><span class="p">)),</span>
                <span class="s">&quot;planet_radius&quot;</span><span class="p">:</span> <span class="n">constant</span><span class="o">.</span><span class="n">R_earth</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s">&quot;planet_mass&quot;</span><span class="p">:</span> <span class="n">constant</span><span class="o">.</span><span class="n">M_earth</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s">&quot;specific_heat_capacity_psurface&quot;</span><span class="p">:</span> <span class="mf">718</span><span class="p">,</span>
                <span class="s">&quot;gravitational_acceleration&quot;</span><span class="p">:</span> <span class="mf">9.80665</span><span class="p">,</span>
                <span class="s">&quot;planet&quot;</span><span class="p">:</span> <span class="s">&quot;Earth&quot;</span>
            <span class="p">}</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The parameter, forecast_length, defines the length of the </span>
<span class="sd">        simulation (defined in hours). Defaults to a value of 72.</span>

<span class="sd">        The parameter, delta_t, defines the change with respect to time</span>
<span class="sd">        (in minutes) defined in the simulation. Defaults to a value of 2.</span>
<span class="sd">        </span>
<span class="sd">        For more information, please refer to amsimp.Backend.__cinit__()</span>
<span class="sd">        method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Add units to forecast length variable.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">forecast_length</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
            <span class="n">forecast_length</span> <span class="o">=</span> <span class="n">forecast_length</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">h</span>
        <span class="c"># Add units to delta_t variable.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">delta_t</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
            <span class="n">delta_t</span> <span class="o">=</span> <span class="n">delta_t</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">min</span>

        <span class="c"># Declare class variables.</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">delta_latitude</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">delta_longitude</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span> <span class="o">=</span> <span class="n">forecast_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span> <span class="o">=</span> <span class="n">delta_t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">ai</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">input_date</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">rh</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">constants</span><span class="p">)</span>
        
        <span class="c"># Ensure self.forecast_length is greater than, or equal to 1.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="mf">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&quot;forecast_length must be a positive number greater than, or equal to 1. The value of forecast_length was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c"># Ensure ai is a boolean value.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&quot;ai must be a boolean value. The value of ai was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ai</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">cpdef</span> <span class="kt">tuple</span> <span class="nf">forecast_period</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the period of time over which the forecast will be generated</span>
<span class="sd">        for. </span>
<span class="sd">        </span>
<span class="sd">        Explain more.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span><span class="o">.</span><span class="n">si</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1</span>

        <span class="c"># Define the forecast period.</span>
        <span class="n">forecast_period</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="mf">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">segments</span>
        <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span><span class="o">.</span><span class="n">unit</span>

        <span class="c"># Convert to seconds.</span>
        <span class="n">delta_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">forecast_period</span><span class="p">,</span> <span class="n">delta_t</span>

    <span class="k">def</span> <span class="nf">__perturbations_errorcheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_perturbation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Explain here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">input_perturbation</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>                
            <span class="c"># Check if first index of tuple is a function.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">input_perturbation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;perturbations must be callable functions.&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__interpolation_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_cube</span><span class="p">,</span> <span class="n">grid_points</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Explain here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">input_cube</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">grid_points</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
        
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">cpdef</span> <span class="nf">simulate</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="nb">bool</span> <span class="n">save_file</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">perturbations_temperature</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">perturbations_zonalwind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">perturbations_meridionalwind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">perturbations_mixingratio</span><span class="o">=</span><span class="bp">None</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a simulation of tropospheric and stratsopheric dynamics.</span>
<span class="sd">        Predictions are made by numerically solving the Primitive</span>
<span class="sd">        Equations. Depending on the parameter specifed in the initialisation</span>
<span class="sd">        of the class, a recurrent neural network may be incorpated in</span>
<span class="sd">        the output.</span>
<span class="sd">        </span>
<span class="sd">        The Primitive Equations are a set of nonlinear partial differential</span>
<span class="sd">        equations that are used to approximate global atmospheric flow and</span>
<span class="sd">        are used in most atmospheric models. They consist of three main sets</span>
<span class="sd">        of balance equations: a continuity equation, conservation of</span>
<span class="sd">        momentum, and a thermal energy equation.</span>

<span class="sd">        The Lax–Friedrichs method is used to numerically solve the Primitive</span>
<span class="sd">        Equations within the software. It is a numerical method for the</span>
<span class="sd">        solution of hyperbolic partial differential equations based on</span>
<span class="sd">        finite differences. The method can be described as the </span>
<span class="sd">        FTCS (forward in time, centered in space) scheme with a numerical</span>
<span class="sd">        dissipation term of 1/2. One can view the Lax–Friedrichs method as an</span>
<span class="sd">        alternative to Godunov&#39;s scheme, where one avoids solving a Riemann</span>
<span class="sd">        problem at each cell interface</span>

<span class="sd">        The parameter, save_file, may be utilised to save the output of</span>
<span class="sd">        this class. The output will be saved as a NetCDF file. These</span>
<span class="sd">        files can be opened by using the Iris library, which can</span>
<span class="sd">        be downloaded via Anaconda Cloud.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Error checking.</span>
        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s">&#39;raise&#39;</span><span class="p">)</span>

        <span class="c"># Ensure save_file is a boolean value.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&quot;save_file must be a boolean value. The value of save_file was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">save_file</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c"># Perturbations error checking.</span>
        <span class="c"># Air temperature.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__perturbations_errorcheck</span><span class="p">(</span><span class="n">perturbations_temperature</span><span class="p">)</span>
        <span class="c"># Zonal wind.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__perturbations_errorcheck</span><span class="p">(</span><span class="n">perturbations_zonalwind</span><span class="p">)</span>
        <span class="c"># Meridional wind.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__perturbations_errorcheck</span><span class="p">(</span><span class="n">perturbations_meridionalwind</span><span class="p">)</span>
        <span class="c"># Mixing Ratio.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__perturbations_errorcheck</span><span class="p">(</span><span class="n">perturbations_mixingratio</span><span class="p">)</span>

        <span class="c"># Define variables that do not vary with respect to time.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">latitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">longitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">()</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">pressure_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">(</span><span class="n">dim_3d</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">interpolate_pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="n">pressure</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="n">pressure</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pressure</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressure</span><span class="p">[</span><span class="mf">1</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="k">cdef</span> <span class="nf">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_period</span><span class="p">()[</span><span class="mf">0</span><span class="p">]</span>
        
        <span class="c"># The Coriolis parameter at various latitudes of the Earth&#39;s surface,</span>
        <span class="c"># under various approximations.</span>
        <span class="c"># No approximation.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coriolis_parameter</span><span class="p">()</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">s</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_3dimensional_array</span><span class="p">(</span><span class="n">parameter</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mf">1</span><span class="p">)</span>

        <span class="c"># Define the change with respect to time.</span>
        <span class="k">cdef</span> <span class="nf">delta_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_period</span><span class="p">()[</span><span class="mf">1</span><span class="p">]</span>
        <span class="c"># Forecast length.</span>
        <span class="k">cdef</span> <span class="nf">forecast_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">t</span> <span class="o">=</span> <span class="mf">0</span>

        <span class="c"># Define initial conditions.</span>
        <span class="c"># Gravitational Acceleration.</span>
        <span class="k">cdef</span> <span class="nf">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>
        <span class="c"># Geopotential Height.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geopotential_height</span><span class="p">()</span>
        <span class="c"># Wind.</span>
        <span class="k">cdef</span> <span class="kt">tuple</span> <span class="nf">wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind</span><span class="p">()</span>
        <span class="c"># Zonal Wind.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">u</span> <span class="o">=</span> <span class="n">wind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="c"># Meridional Wind.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">v</span> <span class="o">=</span> <span class="n">wind</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
        <span class="c"># Vertical Motion.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">omega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertical_motion</span><span class="p">()</span>
        <span class="c"># Temperature.</span>
        <span class="c"># Air Temperature.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">()</span>
        <span class="c"># Virtual Temperature.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">T_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtual_temperature</span><span class="p">()</span>
        <span class="c"># Relative Humidity.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">rh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_humidity</span><span class="p">()</span>
        <span class="c"># Mixing Ratio.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mixing_ratio</span><span class="p">()</span>
        <span class="c"># Precipitable Water.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">pwv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precipitable_water</span><span class="p">()</span>

        <span class="c"># Prediction from Recurrent Neural Network.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">prediction_ai_temp</span><span class="p">,</span> <span class="nf">prediction_ai_height</span><span class="p">,</span> <span class="nf">prediction_ai_rh</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">iterator_ai</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="p">:</span>
            <span class="n">prediction_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_prediction</span><span class="p">()</span>
            <span class="n">prediction_ai_height</span> <span class="o">=</span> <span class="n">prediction_ai</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">m</span>
            <span class="n">prediction_ai_temp</span> <span class="o">=</span> <span class="n">prediction_ai</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">K</span>
            <span class="n">prediction_ai_rh</span> <span class="o">=</span> <span class="n">prediction_ai</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">percent</span>
            <span class="n">iterator_ai</span> <span class="o">=</span> <span class="mf">0</span>

        <span class="c"># Define extra variable types.</span>
        <span class="c"># Numy Arrays.</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">T_n</span><span class="p">,</span> <span class="nf">q_n</span><span class="p">,</span> <span class="nf">u_n</span><span class="p">,</span> <span class="nf">v_n</span><span class="p">,</span> <span class="nf">height_n</span><span class="p">,</span> <span class="nf">A</span><span class="p">,</span> <span class="nf">B</span><span class="p">,</span> <span class="nf">C</span><span class="p">,</span> <span class="nf">D</span><span class="p">,</span> <span class="nf">E</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">RHS</span><span class="p">,</span> <span class="nf">e</span><span class="p">,</span> <span class="nf">T_c</span><span class="p">,</span> <span class="nf">sat_vapor_pressure</span><span class="p">,</span> <span class="nf">geopotential_height</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">mean_u</span><span class="p">,</span> <span class="nf">mean_v</span><span class="p">,</span> <span class="nf">mean_T</span><span class="p">,</span> <span class="nf">mean_q</span><span class="p">,</span> <span class="nf">temperature</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">virtual_temperature</span><span class="p">,</span> <span class="nf">zonal_wind</span><span class="p">,</span> <span class="nf">meridional_wind</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">static_stability</span><span class="p">,</span> <span class="nf">relative_humidity</span><span class="p">,</span> <span class="nf">mixing_ratio</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">precipitable_water</span><span class="p">,</span> <span class="nf">Tv_layers</span><span class="p">,</span> <span class="nf">z_0</span><span class="p">,</span> <span class="nf">z_1</span><span class="p">,</span> <span class="nf">z_2</span><span class="p">,</span> <span class="nf">h</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">Tv_layer</span><span class="p">,</span> <span class="nf">log_pressure_layer</span>
        <span class="c"># Booleans.</span>
        <span class="k">cdef</span> <span class="kt">bool</span> <span class="nf">break_loop</span>
        <span class="c"># Ints / Floats.</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">len_p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span>
        <span class="c"># Tuples.</span>
        <span class="k">cdef</span> <span class="kt">tuple</span> <span class="nf">shape</span><span class="p">,</span> <span class="nf">shape_2d</span>

        <span class="c"># Create a bar to determine progress.</span>
        <span class="n">max_bar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">IncrementalBar</span><span class="p">(</span><span class="s">&#39;Progress&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">max_bar</span><span class="p">)</span>
        <span class="c"># Start progress bar.</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

        <span class="c"># Define NumPy array for ouputs.</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pressure</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">latitude</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">longitude</span><span class="p">))</span>
        <span class="n">shape_2d</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">latitude</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">longitude</span><span class="p">))</span>
        <span class="c"># Geopotential Height.</span>
        <span class="n">geopotential_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">height</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">geopotential_height</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">height</span>
        <span class="c"># Temperature.</span>
        <span class="c"># Air Temperature.</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">temperature</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span>
        <span class="n">T_n</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c"># Virtual Temperature.</span>
        <span class="n">virtual_temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">T_v</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">virtual_temperature</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_v</span> 
        <span class="c"># Geostrophic Wind.</span>
        <span class="c"># Zonal Wind.</span>
        <span class="n">zonal_wind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">zonal_wind</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">u</span>
        <span class="n">u_n</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c"># Meridional Wind.</span>
        <span class="n">meridional_wind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">meridional_wind</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">v_n</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c"># Vertical Motion.</span>
        <span class="n">vertical_motion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">omega</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">vertical_motion</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">omega</span>
        <span class="c"># Relative Humidity.</span>
        <span class="n">relative_humidity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">rh</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">relative_humidity</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rh</span>
        <span class="c"># Mixing Ratio.</span>
        <span class="n">mixing_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">mixing_ratio</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">q</span>
        <span class="n">q_n</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c"># Precipitable Water.</span>
        <span class="n">precipitable_water</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape_2d</span><span class="p">)</span> <span class="o">*</span> <span class="n">pwv</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">precipitable_water</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">pwv</span>

        <span class="c"># Define the initial state for the perturbation functions.</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Wind</span><span class="p">(</span>
            <span class="n">delta_latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_latitude</span><span class="p">,</span>
            <span class="n">delta_longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_longitude</span><span class="p">,</span>
            <span class="n">input_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">psurfaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">(),</span>
            <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">(),</span>
            <span class="n">lon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">(),</span>
            <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> 
            <span class="n">temp</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> 
            <span class="n">rh</span><span class="o">=</span><span class="n">rh</span><span class="p">,</span>
            <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
            <span class="n">constants</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constants</span> 
        <span class="p">)</span>

        <span class="c"># Define the coordinates for the cubes. </span>
        <span class="c"># Latitude.</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">DimCoord</span><span class="p">(</span>
            <span class="n">latitude</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s">&#39;latitude&#39;</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s">&#39;degrees&#39;</span>
        <span class="p">)</span>
        <span class="c"># Longitude</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">DimCoord</span><span class="p">(</span>
            <span class="n">longitude</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s">&#39;longitude&#39;</span><span class="p">,</span> 
            <span class="n">units</span><span class="o">=</span><span class="s">&#39;degrees&#39;</span>
        <span class="p">)</span>
        <span class="c"># Pressure Surfaces.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">DimCoord</span><span class="p">(</span>
            <span class="n">pressure</span><span class="p">,</span>
            <span class="n">long_name</span><span class="o">=</span><span class="s">&#39;pressure&#39;</span><span class="p">,</span> 
            <span class="n">units</span><span class="o">=</span><span class="s">&#39;hPa&#39;</span>
        <span class="p">)</span>
        <span class="c"># Time.</span>
        <span class="n">forecast_period</span> <span class="o">=</span> <span class="n">DimCoord</span><span class="p">(</span>
            <span class="n">time</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s">&#39;forecast_period&#39;</span><span class="p">,</span> 
            <span class="n">units</span><span class="o">=</span><span class="s">&#39;hours&#39;</span>
        <span class="p">)</span>
        <span class="c"># Forecast reference time.</span>
        <span class="n">ref_time</span> <span class="o">=</span> <span class="n">AuxCoord</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">),</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s">&#39;forecast_reference_time&#39;</span>
        <span class="p">)</span>

        <span class="c"># Determine geopotential height of lowest constant pressure surface for</span>
        <span class="c"># the integration of the Hydrostatic Equation. </span>
        <span class="c"># Define grid to interpolate onto.</span>
        <span class="n">grid_points</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;pressure&#39;</span><span class="p">,</span>  <span class="n">interpolate_pressure</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;latitude&#39;</span><span class="p">,</span>  <span class="n">latitude</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;longitude&#39;</span><span class="p">,</span> <span class="n">longitude</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="c"># Define cube.</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">height</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s">&#39;geopotential_height&#39;</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span>
            <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mf">0</span><span class="p">),</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="mf">1</span><span class="p">),</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="mf">2</span><span class="p">)</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c"># Interpolation of geopotential height based on new grid.</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">grid_points</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
        <span class="n">z_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">())[</span><span class="mf">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">height</span><span class="o">.</span><span class="n">unit</span>

        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">nt</span> <span class="o">=</span> <span class="mf">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">forecast_length</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="c"># Wind</span>
                <span class="c"># Zonal Wind.</span>
                <span class="c"># Determine each term in the zonal momentum equation.</span>
                <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_longitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
                <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_latitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">v</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
                <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_pressure</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">omega</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
                <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_longitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">g</span><span class="o">*</span><span class="n">height</span><span class="p">)</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">v</span>

                <span class="c"># Add any perturbations of zonal wind defined by the user.</span>
                <span class="k">if</span> <span class="n">perturbations_zonalwind</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">perturbations_zonalwind</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">E</span><span class="o">.</span><span class="n">unit</span>

                <span class="c"># Sum the RHS terms and multiple by the time step.</span>
                <span class="n">RHS</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="n">B</span> <span class="o">+</span> <span class="n">C</span> <span class="o">+</span> <span class="n">D</span> <span class="o">+</span> <span class="n">E</span> <span class="o">+</span> <span class="n">perturbations</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_t</span>
                <span class="n">mean_u</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">u</span><span class="p">[</span><span class="mf">2</span><span class="p">:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[:</span><span class="o">-</span><span class="mf">2</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="n">u</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mf">2</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="n">u</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">:]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span> <span class="o">/</span> <span class="mf">6</span>
                <span class="n">u_n</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_u</span> <span class="o">+</span> <span class="n">RHS</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>

                <span class="c"># Meridional Wind.</span>
                <span class="c"># Determine each term in the meridional momentum equation.</span>
                <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_longitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">u</span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
                <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_latitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">v</span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
                <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_pressure</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">omega</span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
                <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_latitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">g</span><span class="o">*</span><span class="n">height</span><span class="p">)</span>
                <span class="n">E</span> <span class="o">=</span> <span class="o">-</span><span class="n">f</span> <span class="o">*</span> <span class="n">u</span>

                <span class="c"># Add any perturbations of meridional wind defined by the user.</span>
                <span class="k">if</span> <span class="n">perturbations_meridionalwind</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">perturbations_meridionalwind</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">E</span><span class="o">.</span><span class="n">unit</span>

                <span class="c"># Sum the RHS terms and multiple by the time step.</span>
                <span class="n">RHS</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="n">B</span> <span class="o">+</span> <span class="n">C</span> <span class="o">+</span> <span class="n">D</span> <span class="o">+</span> <span class="n">E</span> <span class="o">+</span> <span class="n">perturbations</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_t</span>
                <span class="n">mean_v</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">v</span><span class="p">[</span><span class="mf">2</span><span class="p">:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mf">2</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="n">v</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mf">2</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="n">v</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">:]</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span> <span class="o">/</span> <span class="mf">6</span>
                <span class="n">v_n</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_v</span> <span class="o">+</span> <span class="n">RHS</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>

                <span class="c"># Temperature.</span>
                <span class="c"># Air Temperature.</span>
                <span class="c"># Thermodynamic Equation.</span>
                <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_longitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">u</span><span class="o">*</span><span class="n">T</span><span class="p">)</span>
                <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_latitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">v</span><span class="o">*</span><span class="n">T</span><span class="p">)</span>
                <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_pressure</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">omega</span><span class="o">*</span><span class="n">T</span><span class="p">)</span>
                <span class="n">D</span> <span class="o">=</span> <span class="n">omega</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">pressure_3d</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_p</span><span class="p">))</span>

                <span class="c"># Add any perturbations of air temperature defined by the user.</span>
                <span class="k">if</span> <span class="n">perturbations_temperature</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">perturbations_temperature</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">D</span><span class="o">.</span><span class="n">unit</span>
                
                <span class="c"># Sum the RHS terms and multiple by the time step.</span>
                <span class="n">RHS</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="n">B</span> <span class="o">+</span> <span class="n">C</span> <span class="o">+</span> <span class="n">D</span> <span class="o">+</span> <span class="n">perturbations</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_t</span>
                <span class="n">mean_T</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">T</span><span class="p">[</span><span class="mf">2</span><span class="p">:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[:</span><span class="o">-</span><span class="mf">2</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="n">T</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mf">2</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="n">T</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">:]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span> <span class="o">/</span> <span class="mf">6</span>
                <span class="n">T_n</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_T</span> <span class="o">+</span> <span class="n">RHS</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>

                <span class="c"># Mixing ratio</span>
                <span class="c"># The scalar gradients of the mixing ratio.</span>
                <span class="n">dq_dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_longitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
                <span class="n">dq_dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_latitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
                <span class="n">dq_dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_pressure</span><span class="p">(</span><span class="n">parameter</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>

                <span class="c"># Advect mixing ratio via wind.</span>
                <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_longitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">u</span><span class="o">*</span><span class="n">q</span><span class="p">)</span>
                <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_latitude</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">v</span><span class="o">*</span><span class="n">q</span><span class="p">)</span>
                <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_pressure</span><span class="p">(</span><span class="n">parameter</span><span class="o">=-</span><span class="n">omega</span><span class="o">*</span><span class="n">q</span><span class="p">)</span>

                <span class="c"># Add any perturbations of mixing ratio defined by the user.</span>
                <span class="k">if</span> <span class="n">perturbations_mixingratio</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">perturbations_mixingratio</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">perturbations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span><span class="o">.</span><span class="n">unit</span>
                
                <span class="c"># Sum the RHS terms and multiple by the time step.</span>
                <span class="n">RHS</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="n">B</span> <span class="o">+</span> <span class="n">C</span> <span class="o">+</span> <span class="n">perturbations</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_t</span>
                <span class="n">mean_q</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">q</span><span class="p">[</span><span class="mf">2</span><span class="p">:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[:</span><span class="o">-</span><span class="mf">2</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="n">q</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mf">2</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="n">q</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">:]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span> <span class="o">/</span> <span class="mf">6</span>
                <span class="n">q_n</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_q</span> <span class="o">+</span> <span class="n">RHS</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>

                <span class="c"># Vapor pressure.</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">pressure_3d</span> <span class="o">*</span> <span class="n">q_n</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.622</span> <span class="o">+</span> <span class="n">q_n</span><span class="p">)</span>

                <span class="c"># Convert temperature in Kelvin to degrees centigrade.</span>
                <span class="n">T_c</span> <span class="o">=</span> <span class="n">T_n</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mf">273.15</span>
                <span class="c"># Saturated vapor pressure.</span>
                <span class="n">sat_vapor_pressure</span> <span class="o">=</span> <span class="mf">0.61121</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="mf">18.678</span> <span class="o">-</span> <span class="p">(</span><span class="n">T_c</span> <span class="o">/</span> <span class="mf">234.5</span><span class="p">)</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_c</span> <span class="o">/</span> <span class="p">(</span><span class="mf">257.14</span> <span class="o">+</span> <span class="n">T_c</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span> 
                <span class="c"># Add units of measurement.</span>
                <span class="n">sat_vapor_pressure</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">kPa</span>
                <span class="n">sat_vapor_pressure</span> <span class="o">=</span> <span class="n">sat_vapor_pressure</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">hPa</span><span class="p">)</span>

                <span class="c"># Relative Humidity.</span>
                <span class="n">rh</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">sat_vapor_pressure</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100</span>
                <span class="n">rh</span><span class="p">[</span><span class="n">rh</span> <span class="o">&gt;</span> <span class="mf">100</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100</span>
                <span class="n">rh</span><span class="p">[</span><span class="n">rh</span> <span class="o">&lt;</span> <span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0</span>
                <span class="n">rh</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">percent</span>

                <span class="c"># Virtual Temperature.</span>
                <span class="n">T_v</span> <span class="o">=</span> <span class="n">T_n</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="mf">1</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="n">e</span> <span class="o">/</span> <span class="n">pressure_3d</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1</span> <span class="o">-</span> <span class="mf">0.622</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="c"># Geopotential Height (Hydrostatic Balance).</span>
                <span class="c"># Define variables.</span>
                <span class="n">z_1</span> <span class="o">=</span> <span class="n">z_0</span>
                <span class="n">height_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">height</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">height</span><span class="o">.</span><span class="n">unit</span>

                <span class="c"># Interpolation of virtual temperature.</span>
                <span class="c"># Define cube.</span>
                <span class="n">cube</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">T_v</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">standard_name</span><span class="o">=</span><span class="s">&#39;virtual_temperature&#39;</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="s">&#39;K&#39;</span><span class="p">,</span>
                    <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mf">0</span><span class="p">),</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="mf">1</span><span class="p">),</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="mf">2</span><span class="p">)</span>
                    <span class="p">],</span>
                <span class="p">)</span>
                <span class="c"># Interpolate.</span>
                <span class="n">cube</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">grid_points</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
                <span class="c"># Convert to NumPy array</span>
                <span class="n">Tv_layers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="o">*</span> <span class="n">T_v</span><span class="o">.</span><span class="n">unit</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_p</span><span class="p">):</span>
                    <span class="c"># Virtual temperature layer.</span>
                    <span class="n">Tv_layer</span> <span class="o">=</span> <span class="n">Tv_layers</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mf">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

                    <span class="c"># Log pressure of layer.</span>
                    <span class="n">log_pressure_layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">interpolate_pressure</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mf">2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

                    <span class="c"># Determine thickness of layer.</span>
                    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span>
                            <span class="n">Tv_layer</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">log_pressure_layer</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mf">0</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                    <span class="c"># Determine geopotential height of constant pressure</span>
                    <span class="c"># surface.</span>
                    <span class="n">z_2</span> <span class="o">=</span> <span class="n">z_1</span> <span class="o">+</span> <span class="n">h</span>

                    <span class="c"># Redefine bottom pressure surface.</span>
                    <span class="n">z_1</span> <span class="o">=</span> <span class="n">z_2</span>

                    <span class="c"># Add to NumPy array.</span>
                    <span class="n">height_n</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">z_2</span>

                <span class="c"># Recurrent Neural Network.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="p">:</span>
                    <span class="c"># Apply predictions every six hours.</span>
                    <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="mf">0</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">%</span> <span class="mf">21600</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
                        <span class="c"># Geopotential Height.</span>
                        <span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">prediction_ai_height</span><span class="p">[</span><span class="n">iterator_ai</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2</span>
                        <span class="c"># Temperature. </span>
                        <span class="n">T</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">+</span> <span class="n">prediction_ai_temp</span><span class="p">[</span><span class="n">iterator_ai</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2</span>
                        <span class="c"># Relative Humidity.</span>
                        <span class="n">rh</span> <span class="o">=</span> <span class="p">(</span><span class="n">rh</span> <span class="o">+</span> <span class="n">prediction_ai_rh</span><span class="p">[</span><span class="n">iterator_ai</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2</span>
                        <span class="c"># Iterator.</span>
                        <span class="n">iterator_ai</span> <span class="o">+=</span> <span class="mf">1</span>
                
                <span class="c"># Configure the Wind class, so, that it aligns with the</span>
                <span class="c"># paramaters defined by the user.</span>
                <span class="n">break_loop</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">break_loop</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">config</span> <span class="o">=</span> <span class="n">Wind</span><span class="p">(</span>
                            <span class="n">delta_latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_latitude</span><span class="p">,</span>
                            <span class="n">delta_longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_longitude</span><span class="p">,</span>
                            <span class="n">input_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">psurfaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure_surfaces</span><span class="p">(),</span>
                            <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latitude_lines</span><span class="p">(),</span>
                            <span class="n">lon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">longitude_lines</span><span class="p">(),</span>
                            <span class="n">height</span><span class="o">=</span><span class="n">height_n</span><span class="p">,</span> 
                            <span class="n">temp</span><span class="o">=</span><span class="n">T_n</span><span class="p">,</span> 
                            <span class="n">rh</span><span class="o">=</span><span class="n">rh</span><span class="p">,</span>
                            <span class="n">u</span><span class="o">=</span><span class="n">u_n</span><span class="p">,</span>
                            <span class="n">v</span><span class="o">=</span><span class="n">v_n</span><span class="p">,</span>
                            <span class="n">constants</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constants</span> 
                        <span class="p">)</span>
                        <span class="n">break_loop</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="c"># Define other prognostic variables.</span>
                <span class="c"># Precipitable Water.</span>
                <span class="n">pwv</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">precipitable_water</span><span class="p">()</span>

                <span class="c"># Add predictions to NumPy arrays.</span>
                <span class="c"># Geopotential Height.</span>
                <span class="n">geopotential_height</span><span class="p">[</span><span class="n">nt</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">height_n</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">height_n</span>
                <span class="c"># Geostrophic Wind.</span>
                <span class="c"># Zonal Wind.</span>
                <span class="n">zonal_wind</span><span class="p">[</span><span class="n">nt</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">u_n</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">u_n</span>
                <span class="c"># Meridional Wind.</span>
                <span class="n">meridional_wind</span><span class="p">[</span><span class="n">nt</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">v_n</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v_n</span>
                <span class="c"># Temperature.</span>
                <span class="c"># Air Temperature.</span>
                <span class="n">temperature</span><span class="p">[</span><span class="n">nt</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_n</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">T_n</span>
                <span class="c"># Virtual Temperature.</span>
                <span class="n">virtual_temperature</span><span class="p">[</span><span class="n">nt</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_v</span>
                <span class="c"># Relative Humidity.</span>
                <span class="n">relative_humidity</span><span class="p">[</span><span class="n">nt</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rh</span>
                <span class="c"># Mixing Ratio.</span>
                <span class="n">mixing_ratio</span><span class="p">[</span><span class="n">nt</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">q_n</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">q_n</span>
                <span class="c"># Precipitable Water.</span>
                <span class="n">precipitable_water</span><span class="p">[</span><span class="n">nt</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">pwv</span>

                <span class="c"># Add time step.</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="n">delta_t</span><span class="o">.</span><span class="n">value</span>
                <span class="n">nt</span> <span class="o">+=</span> <span class="mf">1</span>
                <span class="n">bar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c"># Cubes.</span>
        <span class="n">grid_points</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;forecast_period&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> 
            <span class="p">(</span><span class="s">&#39;pressure&#39;</span><span class="p">,</span>  <span class="n">pressure</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;latitude&#39;</span><span class="p">,</span>  <span class="n">latitude</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;longitude&#39;</span><span class="p">,</span> <span class="n">longitude</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">grid_points_pwv</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;forecast_period&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;latitude&#39;</span><span class="p">,</span>  <span class="n">latitude</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;longitude&#39;</span><span class="p">,</span> <span class="n">longitude</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="c"># Geopotential Height Cube.</span>
        <span class="n">height_cube</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">geopotential_height</span><span class="p">[:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s">&#39;geopotential_height&#39;</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span>
            <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">forecast_period</span><span class="p">,</span> <span class="mf">0</span><span class="p">),</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">1</span><span class="p">),</span> <span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">2</span><span class="p">),</span> <span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">3</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span>
                <span class="s">&#39;source&#39;</span><span class="p">:</span> <span class="s">&#39;Motus Aeris @ AMSIMP&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">height_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interpolation_cube</span><span class="p">(</span>
            <span class="n">input_cube</span><span class="o">=</span><span class="n">height_cube</span><span class="p">,</span> <span class="n">grid_points</span><span class="o">=</span><span class="n">grid_points</span>
        <span class="p">)</span>
        <span class="n">height_cube</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">ref_time</span><span class="p">)</span>
        <span class="c"># Wind Cubes.</span>
        <span class="c"># Zonal Wind Cube.</span>
        <span class="n">u_cube</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">zonal_wind</span><span class="p">[:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s">&#39;x_wind&#39;</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s">&#39;m s-1&#39;</span><span class="p">,</span>
            <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">forecast_period</span><span class="p">,</span> <span class="mf">0</span><span class="p">),</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">1</span><span class="p">),</span> <span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">2</span><span class="p">),</span> <span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">3</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span>
                <span class="s">&#39;source&#39;</span><span class="p">:</span> <span class="s">&#39;Motus Aeris @ AMSIMP&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">u_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interpolation_cube</span><span class="p">(</span>
            <span class="n">input_cube</span><span class="o">=</span><span class="n">u_cube</span><span class="p">,</span> <span class="n">grid_points</span><span class="o">=</span><span class="n">grid_points</span>
        <span class="p">)</span>
        <span class="n">u_cube</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">ref_time</span><span class="p">)</span>
        <span class="c"># Meridional Wind Cube.</span>
        <span class="n">v_cube</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">meridional_wind</span><span class="p">[:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s">&#39;y_wind&#39;</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s">&#39;m s-1&#39;</span><span class="p">,</span>
            <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">forecast_period</span><span class="p">,</span> <span class="mf">0</span><span class="p">),</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">1</span><span class="p">),</span> <span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">2</span><span class="p">),</span> <span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">3</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span>
                <span class="s">&#39;source&#39;</span><span class="p">:</span> <span class="s">&#39;Motus Aeris @ AMSIMP&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">v_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interpolation_cube</span><span class="p">(</span>
            <span class="n">input_cube</span><span class="o">=</span><span class="n">v_cube</span><span class="p">,</span> <span class="n">grid_points</span><span class="o">=</span><span class="n">grid_points</span>
        <span class="p">)</span>
        <span class="n">v_cube</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">ref_time</span><span class="p">)</span>
        <span class="c"># Temperature.</span>
        <span class="c"># Air Temperature.</span>
        <span class="n">T_cube</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">temperature</span><span class="p">[:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s">&#39;air_temperature&#39;</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s">&#39;K&#39;</span><span class="p">,</span>
            <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">forecast_period</span><span class="p">,</span> <span class="mf">0</span><span class="p">),</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">1</span><span class="p">),</span> <span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">2</span><span class="p">),</span> <span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">3</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span>
                <span class="s">&#39;source&#39;</span><span class="p">:</span> <span class="s">&#39;Motus Aeris @ AMSIMP&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">T_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interpolation_cube</span><span class="p">(</span>
            <span class="n">input_cube</span><span class="o">=</span><span class="n">T_cube</span><span class="p">,</span> <span class="n">grid_points</span><span class="o">=</span><span class="n">grid_points</span>
        <span class="p">)</span>
        <span class="n">T_cube</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">ref_time</span><span class="p">)</span>
        <span class="c"># Virtual Temperature.</span>
        <span class="n">Tv_cube</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">virtual_temperature</span><span class="p">[:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s">&#39;virtual_temperature&#39;</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s">&#39;K&#39;</span><span class="p">,</span>
            <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">forecast_period</span><span class="p">,</span> <span class="mf">0</span><span class="p">),</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">1</span><span class="p">),</span> <span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">2</span><span class="p">),</span> <span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">3</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span>
                <span class="s">&#39;source&#39;</span><span class="p">:</span> <span class="s">&#39;Motus Aeris @ AMSIMP&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">Tv_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interpolation_cube</span><span class="p">(</span>
            <span class="n">input_cube</span><span class="o">=</span><span class="n">Tv_cube</span><span class="p">,</span> <span class="n">grid_points</span><span class="o">=</span><span class="n">grid_points</span>
        <span class="p">)</span>
        <span class="n">Tv_cube</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">ref_time</span><span class="p">)</span>
        <span class="c"># Relative Humidity.</span>
        <span class="n">rh_cube</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">relative_humidity</span><span class="p">[:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s">&#39;relative_humidity&#39;</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s">&#39;%&#39;</span><span class="p">,</span>
            <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">forecast_period</span><span class="p">,</span> <span class="mf">0</span><span class="p">),</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">1</span><span class="p">),</span> <span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">2</span><span class="p">),</span> <span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">3</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span>
                <span class="s">&#39;source&#39;</span><span class="p">:</span> <span class="s">&#39;Motus Aeris @ AMSIMP&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">rh_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interpolation_cube</span><span class="p">(</span>
            <span class="n">input_cube</span><span class="o">=</span><span class="n">rh_cube</span><span class="p">,</span> <span class="n">grid_points</span><span class="o">=</span><span class="n">grid_points</span>
        <span class="p">)</span>
        <span class="n">rh_cube</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">ref_time</span><span class="p">)</span>
        <span class="c"># Mixing Ratio.</span>
        <span class="n">q_cube</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">mixing_ratio</span><span class="p">[:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span>
            <span class="n">long_name</span><span class="o">=</span><span class="s">&#39;mixing_ratio&#39;</span><span class="p">,</span>
            <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">forecast_period</span><span class="p">,</span> <span class="mf">0</span><span class="p">),</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">1</span><span class="p">),</span> <span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">2</span><span class="p">),</span> <span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">3</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span>
                <span class="s">&#39;source&#39;</span><span class="p">:</span> <span class="s">&#39;Motus Aeris @ AMSIMP&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">q_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interpolation_cube</span><span class="p">(</span>
            <span class="n">input_cube</span><span class="o">=</span><span class="n">q_cube</span><span class="p">,</span> <span class="n">grid_points</span><span class="o">=</span><span class="n">grid_points</span>
        <span class="p">)</span>
        <span class="n">q_cube</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">ref_time</span><span class="p">)</span>
        <span class="c"># Precipitable Water.</span>
        <span class="n">pwv_cube</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">precipitable_water</span><span class="p">[:,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span>
            <span class="n">long_name</span><span class="o">=</span><span class="s">&#39;precipitable_water&#39;</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s">&#39;mm&#39;</span><span class="p">,</span>
            <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">forecast_period</span><span class="p">,</span> <span class="mf">0</span><span class="p">),</span> <span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">1</span><span class="p">),</span> <span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="mf">2</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span>
                <span class="s">&#39;source&#39;</span><span class="p">:</span> <span class="s">&#39;Motus Aeris @ AMSIMP&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">pwv_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interpolation_cube</span><span class="p">(</span>
            <span class="n">input_cube</span><span class="o">=</span><span class="n">pwv_cube</span><span class="p">,</span> <span class="n">grid_points</span><span class="o">=</span><span class="n">grid_points_pwv</span>
        <span class="p">)</span>
        <span class="n">pwv_cube</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">ref_time</span><span class="p">)</span>

        <span class="c"># Create Cube list of output parameters.</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">CubeList</span><span class="p">([</span>
            <span class="n">height_cube</span><span class="p">,</span>
            <span class="n">u_cube</span><span class="p">,</span>
            <span class="n">v_cube</span><span class="p">,</span>
            <span class="n">T_cube</span><span class="p">,</span>
            <span class="n">Tv_cube</span><span class="p">,</span>
            <span class="n">rh_cube</span><span class="p">,</span>
            <span class="n">q_cube</span><span class="p">,</span>
            <span class="n">pwv_cube</span>
        <span class="p">])</span>

        <span class="c"># If specified, save the forecast in the file format, .nc.</span>
        <span class="k">if</span> <span class="n">save_file</span><span class="p">:</span>
            <span class="c"># Establish the file name.</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;motusaeris_amsimp_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.nc&#39;</span>

            <span class="c"># Save.</span>
            <span class="n">save</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c"># Finish progress bar.</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">visualise</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="p">[</span>
                <span class="s">&quot;air_temperature&quot;</span><span class="p">,</span>
                <span class="s">&quot;geopotential_height&quot;</span><span class="p">,</span>
                <span class="s">&quot;precipitable_water&quot;</span><span class="p">,</span>
                <span class="s">&quot;relative_humidity&quot;</span>
            <span class="p">],</span>
            <span class="n">psurface</span><span class="o">=</span><span class="mf">1000</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Explain here.</span>

<span class="sd">        Need to fix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Declare variable types.</span>
        <span class="c"># NumPy arrays</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">time</span><span class="p">,</span> <span class="nf">lat</span><span class="p">,</span> <span class="nf">lon</span><span class="p">,</span> <span class="nf">longitude</span><span class="p">,</span> <span class="nf">data1</span><span class="p">,</span> <span class="nf">data2</span><span class="p">,</span> <span class="nf">data3</span><span class="p">,</span> <span class="nf">data4</span>
        <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">ndarray</span> <span class="nf">level1</span><span class="p">,</span> <span class="nf">level2</span><span class="p">,</span> <span class="nf">level3</span><span class="p">,</span> <span class="nf">level4</span>
        <span class="c"># Floats.</span>
        <span class="k">cdef</span> <span class="kt">float</span> <span class="nf">min1</span><span class="p">,</span> <span class="nf">min2</span><span class="p">,</span> <span class="nf">min3</span><span class="p">,</span> <span class="nf">min4</span><span class="p">,</span> <span class="nf">max1</span><span class="p">,</span> <span class="nf">max2</span><span class="p">,</span> <span class="nf">max3</span><span class="p">,</span> <span class="nf">max4</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planet</span> <span class="o">==</span> <span class="s">&quot;Earth&quot;</span><span class="p">:</span>
            <span class="c"># Error checking.</span>
            <span class="c"># Ensure a dataset is provided.</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;The dataset for simulation must be defined.&quot;</span><span class="p">)</span>

            <span class="c"># Pressure Surface.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pressure</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="s">&quot;pressure&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">points</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">pressure</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="s">&quot;pressure&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">points</span>
            <span class="k">if</span> <span class="n">psurface</span> <span class="o">&lt;</span> <span class="n">pressure</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">psurface</span> <span class="o">&gt;</span> <span class="n">pressure</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&quot;psurface must be a real number within the isobaric boundaries. The value of psurface was: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">psurface</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c"># Index of the nearest pressure surface in amsimp.Backend.pressure_surfaces()</span>
            <span class="n">indx_psurface</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pressure</span> <span class="o">-</span> <span class="n">psurface</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

            <span class="c"># Define the forecast period.</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="s">&quot;forecast_period&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">points</span>
            <span class="n">time_unit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="s">&quot;forecast_period&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>

            <span class="c"># Grid.</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="s">&quot;latitude&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">points</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="s">&quot;longitude&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">points</span>
            <span class="n">longitude</span> <span class="o">=</span> <span class="n">lon</span>

            <span class="c"># Style of graph.</span>
            <span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&quot;fivethirtyeight&quot;</span><span class="p">)</span>

            <span class="c"># Define layout.</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span> <span class="mf">2</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">18.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.340</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.105</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.905</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>

            <span class="c"># Graph 1.</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">EckertIII</span><span class="p">())</span>
            <span class="n">label1</span> <span class="o">=</span> <span class="n">plot</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
            <span class="n">data1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">label1</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="n">data1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mf">3</span><span class="p">:</span> 
                <span class="n">data1</span> <span class="o">=</span> <span class="n">data1</span><span class="p">;</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">data1</span> <span class="o">=</span> <span class="n">data1</span><span class="p">[:,</span> <span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:];</span>
            <span class="n">data1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">unit1</span> <span class="o">=</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">label1</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">units</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
            <span class="n">label1</span> <span class="o">=</span> <span class="n">label1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="c"># Graph 2.</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mf">1</span><span class="p">,</span> <span class="mf">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">EckertIII</span><span class="p">())</span>
            <span class="n">label2</span> <span class="o">=</span> <span class="n">plot</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
            <span class="n">data2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">label2</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="n">data2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mf">3</span><span class="p">:</span>
                <span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span><span class="p">;</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[:,</span> <span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:];</span>
            <span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data2</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">unit2</span> <span class="o">=</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">label2</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">units</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
            <span class="n">label2</span> <span class="o">=</span> <span class="n">label2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="c"># Graph 3.</span>
            <span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="mf">1</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">EckertIII</span><span class="p">())</span>
            <span class="n">label3</span> <span class="o">=</span> <span class="n">plot</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
            <span class="n">data3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">label3</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="n">data3</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mf">3</span><span class="p">:</span>
                <span class="n">data3</span> <span class="o">=</span> <span class="n">data3</span><span class="p">;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data3</span> <span class="o">=</span> <span class="n">data3</span><span class="p">[:,</span> <span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:];</span>
            <span class="n">data3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data3</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">unit3</span> <span class="o">=</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">label3</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">units</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
            <span class="n">label3</span> <span class="o">=</span> <span class="n">label3</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="c"># Graph 4.</span>
            <span class="n">ax4</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">EckertIII</span><span class="p">())</span>
            <span class="n">label4</span> <span class="o">=</span> <span class="n">plot</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span>
            <span class="n">data4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">label4</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">data4</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mf">3</span><span class="p">:</span> 
                <span class="n">data4</span> <span class="o">=</span> <span class="n">data4</span><span class="p">;</span> 
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">data4</span> <span class="o">=</span> <span class="n">data4</span><span class="p">[:,</span> <span class="n">indx_psurface</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:];</span>
            <span class="n">data4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data4</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">unit4</span> <span class="o">=</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">label4</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">units</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
            <span class="n">label4</span> <span class="o">=</span> <span class="n">label4</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

            <span class="c"># Get date.</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="s">&quot;forecast_reference_time&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)):</span>
                <span class="c"># Plot 1.</span>
                <span class="c"># EckertIII projection details.</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_global</span><span class="p">()</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">gridlines</span><span class="p">()</span>

                <span class="c"># Add SALT to the graph.</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&quot;Longitude ($\lambda$)&quot;</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&quot;Latitude ($\phi$)&quot;</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label1</span><span class="p">)</span>

                <span class="c"># Contour plot.</span>
                <span class="n">cmap1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&quot;hot&quot;</span><span class="p">)</span>
                <span class="n">min1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span>
                <span class="n">max1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span>
                <span class="n">level1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min1</span><span class="p">,</span> <span class="n">max1</span><span class="p">,</span> <span class="mf">21</span><span class="p">)</span>
                <span class="n">data1_plot</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">add_cyclic_point</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="n">longitude</span><span class="p">)</span>
                <span class="n">contour1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
                    <span class="n">lon</span><span class="p">,</span>
                    <span class="n">lat</span><span class="p">,</span>
                    <span class="n">data1_plot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="n">cmap1</span><span class="p">,</span>
                    <span class="n">levels</span><span class="o">=</span><span class="n">level1</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
                <span class="p">)</span>

                <span class="c"># Checks for a colorbar.</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
                    <span class="n">cb1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">contour1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
                    <span class="n">tick_locator</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mf">10</span><span class="p">)</span>
                    <span class="n">cb1</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">tick_locator</span>
                    <span class="n">cb1</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
                    <span class="n">cb1</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">unit1</span><span class="p">)</span>

                <span class="c"># Plot 2.</span>
                <span class="n">cmap2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&quot;jet&quot;</span><span class="p">)</span>
                <span class="n">min2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span>
                <span class="n">max2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span>
                <span class="n">level2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min2</span><span class="p">,</span> <span class="n">max2</span><span class="p">,</span> <span class="mf">21</span><span class="p">)</span>
                <span class="n">data2_plot</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">add_cyclic_point</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="n">longitude</span><span class="p">)</span>
                <span class="n">contour2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
                    <span class="n">lon</span><span class="p">,</span>
                    <span class="n">lat</span><span class="p">,</span> 
                    <span class="n">data2_plot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> 
                    <span class="n">cmap</span><span class="o">=</span><span class="n">cmap2</span><span class="p">,</span> 
                    <span class="n">levels</span><span class="o">=</span><span class="n">level2</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
                <span class="p">)</span>

                <span class="c"># EckertIII projection details.</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">set_global</span><span class="p">()</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">gridlines</span><span class="p">()</span>

                <span class="c"># Checks for a colorbar.</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
                    <span class="n">cb2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">contour2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
                    <span class="n">tick_locator</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mf">10</span><span class="p">)</span>
                    <span class="n">cb2</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">tick_locator</span>
                    <span class="n">cb2</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
                    <span class="n">cb2</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">unit2</span><span class="p">)</span>

                <span class="c"># Add SALT to the graph.</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&quot;Longitude ($\lambda$)&quot;</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&quot;Latitude ($\phi$)&quot;</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label2</span><span class="p">)</span>

                <span class="c"># Plot 3.</span>
                <span class="n">cmap3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&quot;seismic&quot;</span><span class="p">)</span>
                <span class="n">min3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data3</span><span class="p">)</span>
                <span class="n">max3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data3</span><span class="p">)</span>
                <span class="n">level3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min3</span><span class="p">,</span> <span class="n">max3</span><span class="p">,</span> <span class="mf">21</span><span class="p">)</span>
                <span class="n">data3_plot</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">add_cyclic_point</span><span class="p">(</span><span class="n">data3</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="n">longitude</span><span class="p">)</span>
                <span class="n">contour3</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
                    <span class="n">lon</span><span class="p">,</span> 
                    <span class="n">lat</span><span class="p">,</span> 
                    <span class="n">data3_plot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> 
                    <span class="n">cmap</span><span class="o">=</span><span class="n">cmap3</span><span class="p">,</span> 
                    <span class="n">levels</span><span class="o">=</span><span class="n">level3</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
                <span class="p">)</span>

                <span class="c"># EckertIII projection details.</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_global</span><span class="p">()</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">gridlines</span><span class="p">()</span>

                <span class="c"># Checks for a colorbar.</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
                    <span class="n">cb3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">contour3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">)</span>
                    <span class="n">tick_locator</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mf">10</span><span class="p">)</span>
                    <span class="n">cb3</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">tick_locator</span>
                    <span class="n">cb3</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
                    <span class="n">cb3</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">unit3</span><span class="p">)</span>

                <span class="c"># Add SALT to the graph.</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&quot;Longitude ($\lambda$)&quot;</span><span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&quot;Latitude ($\phi$)&quot;</span><span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label3</span><span class="p">)</span>

                <span class="c"># Plot 4.</span>
                <span class="n">min4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data4</span><span class="p">)</span>
                <span class="n">max4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data4</span><span class="p">)</span>
                <span class="n">level4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min4</span><span class="p">,</span> <span class="n">max4</span><span class="p">,</span> <span class="mf">21</span><span class="p">)</span>
                <span class="n">data4_plot</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">add_cyclic_point</span><span class="p">(</span><span class="n">data4</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="n">longitude</span><span class="p">)</span>
                <span class="n">contour4</span> <span class="o">=</span> <span class="n">ax4</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
                    <span class="n">lon</span><span class="p">,</span> 
                    <span class="n">lat</span><span class="p">,</span> 
                    <span class="n">data4_plot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> 
                    <span class="n">levels</span><span class="o">=</span><span class="n">level4</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
                <span class="p">)</span>

                <span class="c"># EckertIII projection details.</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">set_global</span><span class="p">()</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">gridlines</span><span class="p">()</span>

                <span class="c"># Checks for a colorbar.</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
                    <span class="n">cb4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">contour4</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax4</span><span class="p">)</span>
                    <span class="n">tick_locator</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mf">10</span><span class="p">)</span>
                    <span class="n">cb4</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">tick_locator</span>
                    <span class="n">cb4</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
                    <span class="n">cb4</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">unit4</span><span class="p">)</span>

                <span class="c"># Add SALT to the graph.</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&quot;Longitude ($\lambda$)&quot;</span><span class="p">)</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&quot;Latitude ($\phi$)&quot;</span><span class="p">)</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label4</span><span class="p">)</span>

                <span class="c"># Title</span>
                <span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s">&quot;Motus Aeris @ AMSIMP (&quot;</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="s">&quot;, +&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mf">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">time_unit</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pressure</span><span class="p">[</span><span class="n">indx_psurface</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot; hPa)&quot;</span>
                <span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

                <span class="c"># Check if folder needs to created, and if so create one.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s">&#39;visualisations&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="c"># Save image to folder.</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;visualisations/timestep_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mf">300</span><span class="p">)</span>

                <span class="c"># Displaying simualtion.</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1</span><span class="p">):</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">ax3</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">ax4</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Compile photos into video using ffmeg.</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;ffmpeg -framerate 30 -i visualisations/timestep_</span><span class="si">%d</span><span class="s">.png -vf format=yuv420p visualise.mp4&quot;</span><span class="p">)</span>
                    
                    <span class="c"># Remove images.</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;visualisations/timestep_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.png&quot;</span><span class="p">)</span>

                    <span class="c"># Remove folder.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="s">&#39;visualisations&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s">&quot;Visualisations for planetary bodies other than Earth is not currently implemented.&quot;</span>
            <span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="refs.html" title="previous chapter (use the left arrow)">References</a>
      </div>
    
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="refs.html" title="References"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">AMSIMP 1.0.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Source Code</a></li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2020, AMSIMP. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>