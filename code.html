
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Source Code &#8212; AMSIMP 0.6.0 documentation</title>
    <link rel="stylesheet" href="_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Operational Model Class" href="api/forecasting.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="api/forecasting.html" title="Operational Model Class"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">AMSIMP 0.6.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar">
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Contents</h2>
    <div class="sidebar-localtoc">
      <ul>
<li><a class="reference internal" href="#">Source Code</a><ul>
<li><a class="reference internal" href="#preprocessing-class">Preprocessing Class</a></li>
<li><a class="reference internal" href="#operational-model-class">Operational Model Class</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
</div>
  <h4>Previous topic</h4>
  <p class="topless"><a href="api/forecasting.html"
                        title="previous chapter">Operational Model Class</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/code.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="index.html">Docs</a></li>
              
              <li>Source Code</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="source-code">
<h1>Source Code<a class="headerlink" href="#source-code" title="Permalink to this headline">¶</a></h1>
<div class="section" id="preprocessing-class">
<h2>Preprocessing Class<a class="headerlink" href="#preprocessing-class" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">AMSIMP Preprocessing Class. For information about this class is</span>
<span class="sd">described below.</span>

<span class="sd">Copyright (C) 2021 AMSIMP</span>

<span class="sd">This program is free software: you can redistribute it and/or modify</span>
<span class="sd">it under the terms of the GNU General Public License as published by</span>
<span class="sd">the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">(at your option) any later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful,</span>
<span class="sd">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">GNU General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU General Public License</span>
<span class="sd">along with this program.  If not, see https://www.gnu.org/licenses/.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># ------------------------------------------------------------------------------#</span>

<span class="c1"># Importing Dependencies</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.mixed_precision</span> <span class="kn">import</span> <span class="n">experimental</span> <span class="k">as</span> <span class="n">mixed_precision</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span>
<span class="kn">from</span> <span class="nn">astropy.units.quantity</span> <span class="kn">import</span> <span class="n">Quantity</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">iris</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># ------------------------------------------------------------------------------#</span>


<span class="k">class</span> <span class="nc">Preprocessing</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the preprocessing class for AMSIMP.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">forecast_length</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">amsimp_ic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">initialisation_conditions</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The parameter, forecast_length, defines the length of the</span>
<span class="sd">        weather forecast (defined in hours). Defaults to a value of 120.</span>
<span class="sd">        It is currently not recommended to generate a climate forecast</span>
<span class="sd">        using this software, as it has not been tested for this purpose.</span>
<span class="sd">        This may change at some point in the future.</span>

<span class="sd">        The parameter, amsimp_ic, is a boolean which states whether the software will</span>
<span class="sd">        utilise the initialisation conditions provided by AMSIMP. The initialisation</span>
<span class="sd">        conditions provided are from the Global Forecasting System. They are</span>
<span class="sd">        currently stored on AMSIMP GitHub repository. It is updated on the 1st, 7th,</span>
<span class="sd">        13th, and 18th hour. Currently, this option does not provide support for</span>
<span class="sd">        an ensemble prediction system. This, however, will be added in a future version</span>
<span class="sd">        of the software.</span>

<span class="sd">        The parameter, initialisation_conditions, defines the state of the atmosphere</span>
<span class="sd">        in the past thirty days in two-hour intervals up to the present</span>
<span class="sd">        moment. The following  parameters must be defined: 2-metre</span>
<span class="sd">        temperature (2m_temperature), 850 hPa temperature (air_temperature),</span>
<span class="sd">        850 hPa geopotential (geopotential), and total precipitation</span>
<span class="sd">        (total_precipitation). The expected input parameter is</span>
<span class="sd">        a file name. Each file must have the same grid points as</span>
<span class="sd">        all of the other cubes. The grid must be 2 dimensional, and have</span>
<span class="sd">        ha spatial resolution of 1 degree, which is approximately 100</span>
<span class="sd">        kilometres. Introplation will be invoked if this is not the case,</span>
<span class="sd">        which may have a negative impact on the performance of the software and</span>
<span class="sd">        by extension the forecast produced. The latitude points must range from</span>
<span class="sd">        -90 to 90, and the longitude points must range from 0 to 360.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Suppress Tensorflow warnings.</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_CPP_MIN_LOG_LEVEL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>

        <span class="c1"># Make the aforementioned variables available else where in the class.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amsimp_ic</span> <span class="o">=</span> <span class="n">amsimp_ic</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">forecast_length</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Quantity</span><span class="p">:</span>
            <span class="n">forecast_length</span> <span class="o">*=</span> <span class="n">units</span><span class="o">.</span><span class="n">hr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span> <span class="o">=</span> <span class="n">forecast_length</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">hr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialisation_conditions</span> <span class="o">=</span> <span class="n">initialisation_conditions</span>

        <span class="c1"># Ensure self.amsimp_ic is a boolean value.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amsimp_ic</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter, amsimp_ic, must be a boolean value.&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure self.forecast_length is greater than, or equal to 1.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The parameter, forecast_length, must be a positive number greater than, or equal to 1. &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;The value of forecast_length was: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Ensure self.forecast_length is a factor of 4.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span><span class="o">.</span><span class="n">value</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The parameter, forecast_length, must be evenly divisible by four.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Ensure the parameter, self.initialisation_conditions, is not defined when the</span>
        <span class="c1"># parameter self.amsimp_ic is defined to be true.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">amsimp_ic</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialisation_conditions</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;The parameter, initialisation_conditions, must not be defined when amsimp_ic is defined to be true.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Error checking if self.initialisation_conditions is defined.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialisation_conditions</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Ensure self.initialisation_conditions is a string value.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialisation_conditions</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The parameter, initialisation_conditions, must be a string value.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Check if file provided to the software exists.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialisation_conditions</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                    <span class="s2">&quot;The file provided to the software could not be located.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Output warning if file is not of the format, NetCDF.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;.nc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialisation_conditions</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Warning</span><span class="p">(</span>
                    <span class="s2">&quot;Currently AMSIMP only officially supports the NetCDF file format.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Function to check for an internet connection.</span>
        <span class="k">def</span> <span class="nf">is_connected</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;www.github.com&quot;</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check for an internet connection.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_connected</span><span class="p">()</span> <span class="ow">and</span> <span class="n">amsimp_ic</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;You must connect to the internet in order to utilise AMSIMP.&quot;</span>
                <span class="o">+</span> <span class="s2">&quot; Apologies for any inconvenience caused.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------------------#</span>

    <span class="k">def</span> <span class="nf">__download_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">desc</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generates and downloads a cube with the required parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        url : `str`</span>
<span class="sd">            The url of the required parameter to download</span>
<span class="sd">        desc : `str`</span>
<span class="sd">            The name of the required parameter to download</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `iris.cube.Cube`</span>
<span class="sd">            Cube of the downloaded parameter</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method is activated when the parameter, amsimp_ic, is defined to</span>
<span class="sd">        be true. The data is downloaded from the AMSIMP Initial Conditions</span>
<span class="sd">        repository. This is intended as a private method, and may not function</span>
<span class="sd">        correctly if used.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        load_dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create download request.</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Size of file.</span>
        <span class="n">total_size_in_bytes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Size of block.</span>
        <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span>  <span class="c1"># 1 Kibibyte</span>

        <span class="c1">#  Define download progress bar.</span>
        <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total_size_in_bytes</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;iB&quot;</span><span class="p">,</span>
            <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Downloading </span><span class="si">{}</span><span class="s2"> initialisation condition&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Download file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;temp.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">block_size</span><span class="p">):</span>
                <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Close progress bar.</span>
        <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Determine if the file was downloaded in its entirety.</span>
        <span class="k">if</span> <span class="n">total_size_in_bytes</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">progress_bar</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="n">total_size_in_bytes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;An unknown error occurred, which resulted in the download failing.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Load parameter from dataset.</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;temp.nc&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">parameter</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># Remove temporary file.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;temp.nc&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parameter</span>

    <span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generates a cube list with the required dataset loaded, either the</span>
<span class="sd">        file provided is loaded or the files from the AMSIMP Initial Conditions</span>
<span class="sd">        repository are downloaded and saved into a single file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `iris.cube.CubeList`</span>
<span class="sd">            Cube list with the required dataset loaded</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The AMSIMP Initial Conditions repository is update four times daily, at</span>
<span class="sd">        1 am, 7 am, 1 pm, and 7 pm. The near real-time initialisation conditions</span>
<span class="sd">        are provided by the National Oceanic and Atmospheric Adminstrations&#39;</span>
<span class="sd">        Global Data Assimilation System (GDAS).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load dataset based on whether the user defined the initialisation</span>
        <span class="c1"># conditions, or not.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">amsimp_ic</span><span class="p">:</span>
            <span class="c1"># Download file from the GitHub repository if necessary.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;initialisation_conditions.nc&quot;</span><span class="p">):</span>
                <span class="c1"># 2 metre temperature.</span>
                <span class="n">t2m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__download_file</span><span class="p">(</span>
                    <span class="s2">&quot;https://github.com/amsimp/initial-conditions/raw/main/initialisation_conditions/2m_temperature.nc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;2 metre temperature&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Total precipitation.</span>
                <span class="n">tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__download_file</span><span class="p">(</span>
                    <span class="s2">&quot;https://github.com/amsimp/initial-conditions/raw/main/initialisation_conditions/total_precipitation.nc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;total precipitation&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Air temperature at 850 hPa.</span>
                <span class="n">t850</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__download_file</span><span class="p">(</span>
                    <span class="s2">&quot;https://github.com/amsimp/initial-conditions/raw/main/initialisation_conditions/air_temperature.nc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;850 hPa air temperature&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Geopotential at 500 hPa.</span>
                <span class="n">z500</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__download_file</span><span class="p">(</span>
                    <span class="s2">&quot;https://github.com/amsimp/initial-conditions/raw/main/initialisation_conditions/geopotential.nc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;500 hPa geopotential&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Define dataset.</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">CubeList</span><span class="p">([</span><span class="n">t2m</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">t850</span><span class="p">,</span> <span class="n">z500</span><span class="p">])</span>

                <span class="c1"># Save dataset.</span>
                <span class="n">iris</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s2">&quot;initialisation_conditions.nc&quot;</span><span class="p">)</span>

            <span class="c1"># Load dataset.</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;initialisation_conditions.nc&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Load dataset provided by the user.</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialisation_conditions</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dataset</span>

    <span class="c1"># ------------------------------------------------------------------------------#</span>

    <span class="k">def</span> <span class="nf">lat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generates an array of latitude lines in accordance with the shape</span>
<span class="sd">        expected by the operational model of the AMSIMP Global Forecast Model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `numpy.ndarray`</span>
<span class="sd">            Latitude lines</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The resolution of this model is approximately 100 kilometres (1 degree).</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        lon</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">721</span><span class="p">)[</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">lat</span>

    <span class="k">def</span> <span class="nf">lon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generates an array of longitude lines in accordance with the shape</span>
<span class="sd">        expected by the operational model of the AMSIMP Global Forecast Model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `numpy.ndarray`</span>
<span class="sd">            Longitude lines</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The resolution of this model is approximately 100 kilometres (1 degree).</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        lon</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">359.75</span><span class="p">,</span> <span class="mi">1440</span><span class="p">)[::</span><span class="mi">4</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">lon</span>

    <span class="c1"># ------------------------------------------------------------------------------#</span>

    <span class="k">def</span> <span class="nf">parameter_extraction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generates a cube list with the expected parameters extracted in the</span>
<span class="sd">        expected order for interplolation and normalisation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `iris.cube.CubeList`</span>
<span class="sd">            Cube list with expected parameters extracted</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The parameters, in this order, are: air temperature at 2 metres above</span>
<span class="sd">        the surface, air temperature at a pressure surface of 850 hectopascals,</span>
<span class="sd">        and geopotential at a pressure surface of 500 hectopascals.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        load_dataset, interpolate_dataset, normalise_dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract the relevant parameters from the dataset.</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;t2m&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">()</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

        <span class="c1"># Ensure all parameters are present.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;All of the expected parameters were not present in the dataset.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Ensure the pressure surface defined is correct if it is relevant for</span>
        <span class="c1"># a given parameter.</span>
        <span class="c1"># Air temperature at 850 hPa.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Retrieve DimCoord from cube.</span>
            <span class="n">t850_p</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s2">&quot;air_temperature&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;pressure&quot;</span><span class="p">)</span>

            <span class="c1"># Ensure units are in hectopascals.</span>
            <span class="n">t850_p</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s2">&quot;hPa&quot;</span><span class="p">)</span>

            <span class="c1"># Check if the pressure surface is at 850 hPa.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">(</span><span class="n">t850_p</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">850</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;The air temperature values provided are not on the correct pressure surface, which is 850 hPa.&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Geopotential at 500 hPa.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Retrieve DimCoord from cube.</span>
            <span class="n">z500_p</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s2">&quot;geopotential&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;pressure&quot;</span><span class="p">)</span>

            <span class="c1"># Ensure units are in hectopascals.</span>
            <span class="n">z500_p</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s2">&quot;hPa&quot;</span><span class="p">)</span>

            <span class="c1"># Check if the pressure surface is at 500 hPa.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">(</span><span class="n">z500_p</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">500</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;The geopotential values provided are not on the correct pressure surface, which is 500 hPa.&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">dataset</span>

    <span class="k">def</span> <span class="nf">interpolate_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generates a cube list with the expected parameters, interpolated</span>
<span class="sd">        if necessary onto the grid required for input into the operational AMSIMP</span>
<span class="sd">        Global Forecast Model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `iris.cube.CubeList`</span>
<span class="sd">            Cube list with interpolated grid for operational model</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method also ensures the expected number of time steps are</span>
<span class="sd">        included, and raises an error when an insufficient number is present.</span>
<span class="sd">        The number of time steps required is 6.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        load_dataset, parameter_extraction, normalise_dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define dataset.</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_extraction</span><span class="p">()</span>

        <span class="c1"># Define expected coordinates.</span>
        <span class="c1"># Latitude.</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">()</span>
        <span class="c1"># Longitude</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">()</span>

        <span class="c1"># Check if the expected number of time steps are present.</span>
        <span class="c1"># If an insufficient number is present.</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Six timesteps are required in order to generate a forecast.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># If an excess number is present.</span>
        <span class="k">elif</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span>

        <span class="c1">#  Check if longitude values contain a negative number.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;longitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The longitude coordinate system provided is not supported. Longitude values must range from 0 to 360.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Define grid points for interpolation.</span>
        <span class="n">grid_points</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="n">lat</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="n">lon</span><span class="p">)]</span>

        <span class="c1"># Loop through dataset.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)):</span>
            <span class="c1"># Interpolate dataset to the required coordinates.</span>
            <span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">grid_points</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">dataset</span>

    <span class="k">def</span> <span class="nf">normalise_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generates a NumPy array with the expected parameters, normalised,</span>
<span class="sd">        processed onto the grid required for input into the operational AMSIMP</span>
<span class="sd">        Global Forecast Model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `numpy.ndarray`</span>
<span class="sd">            Normalised and preprocessed dataset for forecast model input</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method also converts the parameters into the correct units of</span>
<span class="sd">        measurement if it is necessary to do so.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        load_dataset, parameter_extraction, interpolate_dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define dataset.</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_dataset</span><span class="p">()</span>

        <span class="c1"># Define directory.</span>
        <span class="kn">import</span> <span class="nn">amsimp.preprocessing</span>

        <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">amsimp</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>

        <span class="c1"># Load normalisation variables.</span>
        <span class="c1"># Mean.</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s2">&quot;/model/mean.npy&quot;</span><span class="p">)</span>

        <span class="c1"># Standard deviation.</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s2">&quot;/model/std.npy&quot;</span><span class="p">)</span>

        <span class="c1"># Convert cube list to NumPy array.</span>
        <span class="n">dataset_numpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span>
                <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Ensure units are correct.</span>
        <span class="c1"># 2 metre temperature (K).</span>
        <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">)</span>

        <span class="c1"># Air temperature at 850 hPa (K).</span>
        <span class="n">dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">)</span>

        <span class="c1"># Geopotential at 500 hPa (m2 s-2).</span>
        <span class="n">dataset</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s2">&quot;m2 s-2&quot;</span><span class="p">)</span>

        <span class="c1"># Loop through dataset.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Interpolating dataset&quot;</span><span class="p">):</span>
            <span class="c1"># Add to NumPy array.</span>
            <span class="n">dataset_numpy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># Transpose.</span>
        <span class="n">dataset_numpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dataset_numpy</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1">#  Normalise.</span>
        <span class="n">dataset_numpy</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_numpy</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>

        <span class="c1"># Reshape for model input.</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">dataset</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="operational-model-class">
<h2>Operational Model Class<a class="headerlink" href="#operational-model-class" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">AMSIMP Operational Model Class. For information about this</span>
<span class="sd">class is described below.</span>

<span class="sd">Copyright (C) 2021 AMSIMP</span>

<span class="sd">This program is free software: you can redistribute it and/or modify</span>
<span class="sd">it under the terms of the GNU General Public License as published by</span>
<span class="sd">the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">(at your option) any later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful,</span>
<span class="sd">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">GNU General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU General Public License</span>
<span class="sd">along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># -----------------------------------------------------------------------------------------#</span>

<span class="c1"># Importing Dependencies.</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">iris</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">ConvLSTM2D</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Dense</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">BatchNormalization</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">amsimp.preprocessing</span> <span class="kn">import</span> <span class="n">Preprocessing</span>

<span class="c1"># -----------------------------------------------------------------------------------------#</span>


<span class="k">class</span> <span class="nc">OperationalModel</span><span class="p">(</span><span class="n">Preprocessing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the operational model class for AMSIMP.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">model_architecture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generates the operational AMSIMP Global Forecast Model architecture.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `tf.keras.Sequential`</span>
<span class="sd">            Operational AMSIMP Global Forecast Model architecture.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This architecture is currently based on the ConvLSTM layer, which has</span>
<span class="sd">        been pretrained on the dataset from the year 2009 to the year 2016.</span>
<span class="sd">        A major drawback of LSTMs in its handling of spatiotemporal data is due</span>
<span class="sd">        to its usage of full connections in input-to-state and state-to-state</span>
<span class="sd">        transitions in which no spatial information is encoded. To overcome</span>
<span class="sd">        this problem, a distinguishing feature of a ConvLSTM cell is that all</span>
<span class="sd">        the inputs and gates of the ConvLSTM layer are 3D tensors whose last</span>
<span class="sd">        two dimensions are spatial dimensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create, and train models.</span>
        <span class="c1"># Optimiser.</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
        <span class="c1"># Create model.</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>

        <span class="c1"># First layer.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">ConvLSTM2D</span><span class="p">(</span>
                <span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
                <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
                <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span>
                <span class="n">recurrent_activation</span><span class="o">=</span><span class="s2">&quot;hard_sigmoid&quot;</span><span class="p">,</span>
                <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;glorot_uniform&quot;</span><span class="p">,</span>
                <span class="n">unit_forget_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dropout</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">recurrent_dropout</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">go_backwards</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Batch normalisation.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BatchNormalization</span><span class="p">())</span>
        <span class="c1"># Dropout.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>

        <span class="c1"># Second layer.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">ConvLSTM2D</span><span class="p">(</span>
                <span class="n">filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
                <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span>
                <span class="n">recurrent_activation</span><span class="o">=</span><span class="s2">&quot;hard_sigmoid&quot;</span><span class="p">,</span>
                <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;glorot_uniform&quot;</span><span class="p">,</span>
                <span class="n">unit_forget_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dropout</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                <span class="n">recurrent_dropout</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">go_backwards</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Batch normalisation.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BatchNormalization</span><span class="p">())</span>

        <span class="c1"># Third layer.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">ConvLSTM2D</span><span class="p">(</span>
                <span class="n">filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
                <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span>
                <span class="n">recurrent_activation</span><span class="o">=</span><span class="s2">&quot;hard_sigmoid&quot;</span><span class="p">,</span>
                <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;glorot_uniform&quot;</span><span class="p">,</span>
                <span class="n">unit_forget_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dropout</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                <span class="n">recurrent_dropout</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">go_backwards</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Batch normalisation.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BatchNormalization</span><span class="p">())</span>
        <span class="c1"># Dropout.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>

        <span class="c1"># Final layer.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">ConvLSTM2D</span><span class="p">(</span>
                <span class="n">filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
                <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span>
                <span class="n">recurrent_activation</span><span class="o">=</span><span class="s2">&quot;hard_sigmoid&quot;</span><span class="p">,</span>
                <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;glorot_uniform&quot;</span><span class="p">,</span>
                <span class="n">unit_forget_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dropout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">recurrent_dropout</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">go_backwards</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Batch normalisation.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BatchNormalization</span><span class="p">())</span>

        <span class="c1"># Add dense layer.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

        <span class="c1"># Compile model.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mean_absolute_error&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">generate_forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generates a forecast with the current AMSIMP Global Forecast Model</span>
<span class="sd">        architecture.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `iris.cube.CubeList`</span>
<span class="sd">            The forecast generated with the operational model</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This model has been pretrained on the dataset from the year 2009 to the</span>
<span class="sd">        year 2016. The architecture of the current operational model is</span>
<span class="sd">        currently based on the ConvLSTM layer. The prognostic variables are: air</span>
<span class="sd">        temperature at 2 metres above the surface, air temperature at a pressure</span>
<span class="sd">        surface of 850 hectopascals, and geopotential at a pressure surface of</span>
<span class="sd">        500 hectopascals.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        model_architecture</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define model input.</span>
        <span class="n">model_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalise_dataset</span><span class="p">()</span>

        <span class="c1"># Define directory.</span>
        <span class="kn">import</span> <span class="nn">amsimp.preprocessing</span>

        <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">amsimp</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>

        <span class="c1"># Define model and load weights.</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_architecture</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s2">&quot;/model/global_forecast_model.h5&quot;</span><span class="p">)</span>

        <span class="c1"># Define forecast output array.</span>
        <span class="n">model_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">model_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">model_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="n">model_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Add current conditions to output array.</span>
        <span class="n">model_output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_input</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Create iterative predictions.</span>
        <span class="n">it</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mi">12</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Generating forecast&quot;</span>
        <span class="p">)</span>
        <span class="k">while</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># Generate predictions based on current model input.</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">model_input</span><span class="p">)</span>

            <span class="c1"># Add predictions to output array.</span>
            <span class="n">model_output</span><span class="p">[</span><span class="n">it</span> <span class="p">:</span> <span class="n">it</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Define as new model input.</span>
            <span class="n">model_input</span> <span class="o">=</span> <span class="n">predictions</span>

            <span class="c1"># Increment iteration.</span>
            <span class="n">it</span> <span class="o">+=</span> <span class="mi">6</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># Close progress bar.</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Define progress bar.</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Outputting forecast&quot;</span><span class="p">)</span>

        <span class="c1"># Inverse of normalisation.</span>
        <span class="c1"># Load normalisation variables.</span>
        <span class="c1"># Mean.</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s2">&quot;/model/mean.npy&quot;</span><span class="p">)</span>
        <span class="c1"># Standard deviation.</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s2">&quot;/model/std.npy&quot;</span><span class="p">)</span>

        <span class="c1"># Determine inverse.</span>
        <span class="n">model_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_output</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span> <span class="o">+</span> <span class="n">mean</span>

        <span class="c1"># Define forecast for each parameter.</span>
        <span class="c1"># 2 metre temperature.</span>
        <span class="n">t2m</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 850 hPa temperature.</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># 500 hPa geopotential.</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Define time coordinate.</span>
        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_dataset</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="c1"># Define unit of measurement.</span>
        <span class="n">time_unit</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">units</span>
        <span class="c1"># Define values.</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_length</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">model_output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Define the coordinates for the cubes.</span>
        <span class="c1"># Time.</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">DimCoord</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time_unit</span><span class="p">)</span>
        <span class="c1"># Latitude.</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">DimCoord</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">(),</span> <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;degrees&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Longitude</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">DimCoord</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">(),</span> <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;degrees&quot;</span>
        <span class="p">)</span>
        <span class="c1">#  Aux coords.</span>
        <span class="c1"># 850 hPa for temperature.</span>
        <span class="n">p850</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">AuxCoord</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">850</span><span class="p">]),</span> <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;air_pressure&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;hPa&quot;</span>
        <span class="p">)</span>
        <span class="c1"># 500 hPa for geopotential.</span>
        <span class="n">p500</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">AuxCoord</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">500</span><span class="p">]),</span> <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;air_pressure&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;hPa&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Define cubes.</span>
        <span class="c1"># 2 metre temperature.</span>
        <span class="n">t2m</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">Cube</span><span class="p">(</span>
            <span class="n">t2m</span><span class="p">,</span>
            <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span>
            <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;t2m&quot;</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span>
            <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[(</span><span class="n">time</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;AMSIMP Global Forecast Model&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># 850 hPa temperature.</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">Cube</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;air_temperature&quot;</span><span class="p">,</span>
            <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span>
            <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[(</span><span class="n">time</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;AMSIMP Global Forecast Model&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">p850</span><span class="p">)</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># 500 hPa geopotential.</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">Cube</span><span class="p">(</span>
            <span class="n">z</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;geopotential&quot;</span><span class="p">,</span>
            <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s2">&quot;m2 s-2&quot;</span><span class="p">,</span>
            <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[(</span><span class="n">time</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;AMSIMP Global Forecast Model&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">z</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">p500</span><span class="p">)</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># Finish progress bar.</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Define output forecast.</span>
        <span class="n">forecast</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">CubeList</span><span class="p">([</span><span class="n">t2m</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">forecast</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="api/forecasting.html" title="previous chapter (use the left arrow)">Operational Model Class</a>
      </div>
    
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="api/forecasting.html" title="Operational Model Class"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">AMSIMP 0.6.0 documentation</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2021, AMSIMP. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>